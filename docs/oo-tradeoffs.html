<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>16 Trade-offs | R avanzado</title>
<meta name="author" content="Jeshua Romero Guadarrama">
<meta name="generator" content="bookdown 0.24.4 with bs4_book()">
<meta property="og:title" content="16 Trade-offs | R avanzado">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="16 Trade-offs | R avanzado">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1.9000/transition.js"></script><script src="libs/bs3compat-0.3.1.9000/tabs.js"></script><script src="libs/bs3compat-0.3.1.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141212623-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-141212623-1');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><meta name="description" content="16.1 Introduction You now know about the three most important OOP toolkits available in R. Now that you understand their basic operation and the principles that underlie them, we can start to...">
<meta property="og:description" content="16.1 Introduction You now know about the three most important OOP toolkits available in R. Now that you understand their basic operation and the principles that underlie them, we can start to...">
<meta name="twitter:description" content="16.1 Introduction You now know about the three most important OOP toolkits available in R. Now that you understand their basic operation and the principles that underlie them, we can start to...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R avanzado</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li class="book-part">Foundations</li>
<li><a class="" href="foundations-intro.html">Introduction</a></li>
<li><a class="" href="names-values.html"><span class="header-section-number">2</span> Names and values</a></li>
<li><a class="" href="vectors-chap.html"><span class="header-section-number">3</span> Vectors</a></li>
<li><a class="" href="subsetting.html"><span class="header-section-number">4</span> Subsetting</a></li>
<li><a class="" href="control-flow.html"><span class="header-section-number">5</span> Control flow</a></li>
<li><a class="" href="functions.html"><span class="header-section-number">6</span> Functions</a></li>
<li><a class="" href="environments.html"><span class="header-section-number">7</span> Environments</a></li>
<li><a class="" href="conditions.html"><span class="header-section-number">8</span> Conditions</a></li>
<li class="book-part">Functional programming</li>
<li><a class="" href="fp.html">Introduction</a></li>
<li><a class="" href="functionals.html"><span class="header-section-number">9</span> Functionals</a></li>
<li><a class="" href="function-factories.html"><span class="header-section-number">10</span> Function factories</a></li>
<li><a class="" href="function-operators.html"><span class="header-section-number">11</span> Function operators</a></li>
<li class="book-part">Object-oriented programming</li>
<li><a class="" href="oo.html">Introduction</a></li>
<li><a class="" href="base-types.html"><span class="header-section-number">12</span> Base types</a></li>
<li><a class="" href="s3.html"><span class="header-section-number">13</span> S3</a></li>
<li><a class="" href="r6.html"><span class="header-section-number">14</span> R6</a></li>
<li><a class="" href="s4.html"><span class="header-section-number">15</span> S4</a></li>
<li><a class="active" href="oo-tradeoffs.html"><span class="header-section-number">16</span> Trade-offs</a></li>
<li class="book-part">Metaprogramming</li>
<li><a class="" href="metaprogramming.html">Introduction</a></li>
<li><a class="" href="meta-big-picture.html"><span class="header-section-number">17</span> Big picture</a></li>
<li><a class="" href="expressions.html"><span class="header-section-number">18</span> Expressions</a></li>
<li><a class="" href="quasiquotation.html"><span class="header-section-number">19</span> Quasiquotation</a></li>
<li><a class="" href="evaluation.html"><span class="header-section-number">20</span> Evaluation</a></li>
<li><a class="" href="translation.html"><span class="header-section-number">21</span> Translating R code</a></li>
<li class="book-part">Techniques</li>
<li><a class="" href="techniques.html">Introduction</a></li>
<li><a class="" href="debugging.html"><span class="header-section-number">22</span> Debugging</a></li>
<li><a class="" href="perf-measure.html"><span class="header-section-number">23</span> Measuring performance</a></li>
<li><a class="" href="perf-improve.html"><span class="header-section-number">24</span> Improving performance</a></li>
<li><a class="" href="rcpp.html"><span class="header-section-number">25</span> Rewriting R code in C++</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/hadley/adv-r">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="oo-tradeoffs" class="section level1" number="16">
<h1>
<span class="header-section-number">16</span> Trade-offs<a class="anchor" aria-label="anchor" href="#oo-tradeoffs"><i class="fas fa-link"></i></a>
</h1>
<div id="introduction-15" class="section level2" number="16.1">
<h2>
<span class="header-section-number">16.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-15"><i class="fas fa-link"></i></a>
</h2>
<p>You now know about the three most important OOP toolkits available in R. Now that you understand their basic operation and the principles that underlie them, we can start to compare and contrast the systems in order to understand their strengths and weaknesses. This will help you pick the system that is most likely to solve new problems.</p>
<p>Overall, when picking an OO system, I recommend that you default to S3. S3 is simple, and widely used throughout base R and CRAN. While it’s far from perfect, its idiosyncrasies are well understood and there are known approaches to overcome most shortcomings. If you have an existing background in programming you are likely to lean towards R6, because it will feel familiar. I think you should resist this tendency for two reasons. Firstly, if you use R6 it’s very easy to create a non-idiomatic API that will feel very odd to native R users, and will have surprising pain points because of the reference semantics. Secondly, if you stick to R6, you’ll lose out on learning a new way of thinking about OOP that gives you a new set of tools for solving problems.</p>
<div id="outline-14" class="section level3 unnumbered">
<h3>Outline<a class="anchor" aria-label="anchor" href="#outline-14"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>Section <a href="oo-tradeoffs.html#s3-s4">16.2</a> compares S3 and S4. In brief, S4 is more formal and
tends to require more upfront planning. That makes it more suitable for big
projects developed by teams, not individuals.</p></li>
<li><p>Section <a href="oo-tradeoffs.html#s3-r6">16.3</a> compares S3 and R6. This section is quite long because
these two systems are fundamentally different and there are a number of
tradeoffs that you need to consider.</p></li>
</ul>
</div>
<div id="prerequisites-9" class="section level3 unnumbered">
<h3>Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites-9"><i class="fas fa-link"></i></a>
</h3>
<p>You need to be familiar with S3, S4, and R6, as discussed in the previous three chapters.</p>
</div>
</div>
<div id="s3-s4" class="section level2" number="16.2">
<h2>
<span class="header-section-number">16.2</span> S4 versus S3<a class="anchor" aria-label="anchor" href="#s3-s4"><i class="fas fa-link"></i></a>
</h2>
<p>
</p>
<p>Once you’ve mastered S3, S4 is not too difficult to pick up: the underlying ideas are the same, S4 is just more formal, more strict, and more verbose. The strictness and formality of S4 make it well suited for large teams. Since more structure is provided by the system itself, there is less need for convention, and new contributors don’t need as much training. S4 tends to require more upfront design than S3, and this investment is more likely to pay off on larger projects where greater resources are available.</p>
<p>One large team effort where S4 is used to good effect is Bioconductor. Bioconductor is similar to CRAN: it’s a way of sharing packages amongst a wider audience. Bioconductor is smaller than CRAN (~1,300 versus ~10,000 packages, July 2017) and the packages tend to be more tightly integrated because of the shared domain and because Bioconductor has a stricter review process. Bioconductor packages are not required to use S4, but most will because the key data structures (e.g. SummarizedExperiment, IRanges, DNAStringSet) are built using S4.</p>
<p>S4 is also a good fit for complex systems of interrelated objects, and it’s possible to minimise code duplication through careful implementation of methods. The best example of such a system is the Matrix package.<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Douglas Bates and Martin Maechler, &lt;span&gt;“Matrix: Sparse and Dense Matrix Classes and Methods,”&lt;/span&gt; 2018, &lt;a href="https://CRAN.R-project.org/package=Matrix" role="doc-biblioref"&gt;https://CRAN.R-project.org/package=Matrix&lt;/a&gt;.&lt;/p&gt;'><sup>82</sup></a></span> It is designed to efficiently store and compute with many different types of sparse and dense matrices. As of version 1.3.4, it defines 102 classes, 21 generic functions, and 2008 methods, and to give you some idea of the complexity, a small subset of the class graph is shown in Figure <a href="oo-tradeoffs.html#fig:matrix-classes">16.1</a>.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:matrix-classes"></span>
<img src="diagrams/s4/Matrix.png" alt="A small subset of the Matrix class graph showing the inheritance of sparse matrices. Each concrete class inherits from two virtual parents: one that describes how the data is stored (C = column oriented, R = row oriented, T = tagged) and one that describes any restriction on the matrix (s = symmetric, t = triangle, g = general)." width="80%"><p class="caption">
Figure 16.1: A small subset of the Matrix class graph showing the inheritance of sparse matrices. Each concrete class inherits from two virtual parents: one that describes how the data is stored (C = column oriented, R = row oriented, T = tagged) and one that describes any restriction on the matrix (s = symmetric, t = triangle, g = general).
</p>
</div>
<p>This domain is a good fit for S4 because there are often computational shortcuts for specific combinations of sparse matrices. S4 makes it easy to provide a general method that works for all inputs, and then provide more specialised methods where the inputs allow a more efficient implementation. This requires careful planning to avoid method dispatch ambiguity, but the planning pays off with higher performance.</p>
<p>The biggest challenge to using S4 is the combination of increased complexity and absence of a single source of documentation. S4 is a complex system and it can be challenging to use effectively in practice. This wouldn’t be such a problem if S4 documentation wasn’t scattered through R documentation, books, and websites. S4 needs a book length treatment, but that book does not (yet) exist. (The documentation for S3 is no better, but the lack is less painful because S3 is much simpler.)</p>
</div>
<div id="s3-r6" class="section level2" number="16.3">
<h2>
<span class="header-section-number">16.3</span> R6 versus S3<a class="anchor" aria-label="anchor" href="#s3-r6"><i class="fas fa-link"></i></a>
</h2>
<p>
</p>
<p>R6 is a profoundly different OO system from S3 and S4 because it is built on encapsulated objects, rather than generic functions. Additionally R6 objects have reference semantics, which means that they can be modified in place. These two big differences have a number of non-obvious consequences which we’ll explore here:</p>
<ul>
<li><p>A generic is a regular function so it lives in the global namespace. An R6 method
belongs to an object so it lives in a local namespace. This influences how we
think about naming.</p></li>
<li><p>R6’s reference semantics allow methods to simultaneously return a value
and modify an object. This solves a painful problem called “threading state.”</p></li>
<li><p>You invoke an R6 method using <code>$</code>, which is an infix operator. If you set up
your methods correctly you can use chains of method calls as an alternative
to the pipe.</p></li>
</ul>
<p>These are general trade-offs between functional and encapsulated OOP, so they also serve as a discussion of system design in R versus Python.</p>
<div id="namespacing" class="section level3" number="16.3.1">
<h3>
<span class="header-section-number">16.3.1</span> Namespacing<a class="anchor" aria-label="anchor" href="#namespacing"><i class="fas fa-link"></i></a>
</h3>
<p>One non-obvious difference between S3 and R6 is the space in which methods are found:</p>
<ul>
<li>Generic functions are global: all packages share the same namespace.</li>
<li>Encapsulated methods are local: methods are bound to a single object.</li>
</ul>
<p>The advantage of a global namespace is that multiple packages can use the same verbs for working with different types of objects. Generic functions provide a uniform API that makes it easier to perform typical actions with a new object because there are strong naming conventions. This works well for data analysis because you often want to do the same thing to different types of objects. In particular, this is one reason that R’s modelling system is so useful: regardless of where the model has been implemented you always work with it using the same set of tools (<code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code>, <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>, …).</p>
<p>The disadvantage of a global namespace is that it forces you to think more deeply about naming. You want to avoid multiple generics with the same name in different packages because it requires the user to type <code>::</code> frequently. This can be hard because function names are usually English verbs, and verbs often have multiple meanings. Take <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> for example:</p>
<div class="sourceCode" id="cb657"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>       <span class="co"># plot some data</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">bank_heist</span><span class="op">)</span> <span class="co"># plot a crime</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">land</span><span class="op">)</span>       <span class="co"># create a new plot of land</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">movie</span><span class="op">)</span>      <span class="co"># extract plot of a movie</span></code></pre></div>
<p>Generally, you should avoid methods that are homonyms of the original generic, and instead define a new generic.</p>
<p>This problem doesn’t occur with R6 methods because they are scoped to the object. The following code is fine, because there is no implication that the plot method of two different R6 objects has the same meaning:</p>
<div class="sourceCode" id="cb658"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span>
<span class="va">bank_heist</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span>
<span class="va">land</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span>
<span class="va">movie</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>These considerations also apply to the arguments to the generic. S3 generics must have the same core arguments, which means they generally have non-specific names like <code>x</code> or <code>.data</code>. S3 generics generally need <code>...</code> to pass on additional arguments to methods, but this has the downside that misspelled argument names will not create an error. In comparison, R6 methods can vary more widely and use more specific and evocative argument names.</p>
<p>A secondary advantage of local namespacing is that creating an R6 method is very cheap. Most encapsulated OO languages encourage you to create many small methods, each doing one thing well with an evocative name. Creating a new S3 method is more expensive, because you may also have to create a generic, and think about the naming issues described above. That means that the advice to create many small methods does not apply to S3. It’s still a good idea to break your code down into small, easily understood chunks, but they should generally just be regular functions, not methods.</p>
</div>
<div id="threading-state" class="section level3" number="16.3.2">
<h3>
<span class="header-section-number">16.3.2</span> Threading state<a class="anchor" aria-label="anchor" href="#threading-state"><i class="fas fa-link"></i></a>
</h3>
<p>
</p>
<p>One challenge of programming with S3 is when you want to both return a value and modify the object. This violates our guideline that a function should either be called for its return value or for its side effects, but is necessary in a handful of cases.</p>
<p>For example, imagine you want to create a <strong>stack</strong> of objects. A stack has two main methods:</p>
<ul>
<li>
<code>push()</code> adds a new object to the top of the stack.</li>
<li>
<code>pop()</code> returns the top most value, and removes it from the stack.</li>
</ul>
<p>The implementation of the constructor and the <code>push()</code> method is straightforward. A stack contains a list of items, and pushing an object to the stack simply appends to this list.</p>
<div class="sourceCode" id="cb659"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_stack</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">items</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>items <span class="op">=</span> <span class="va">items</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"stack"</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">push</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span><span class="op">$</span><span class="va">items</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">items</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>
  <span class="va">x</span>
<span class="op">}</span></code></pre></div>
<p>(I haven’t created a real method for <code>push()</code> because making it generic would just make this example more complicated for no real benefit.)</p>
<p>Implementing <code>pop()</code> is more challenging because it has to both return a value (the object at the top of the stack), and have a side-effect (remove that object from that top). Since we can’t modify the input object in S3 we need to return two things: the value, and the updated object.</p>
<div class="sourceCode" id="cb660"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pop</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">items</span><span class="op">)</span>
  
  <span class="va">item</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">items</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span>
  <span class="va">x</span><span class="op">$</span><span class="va">items</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">items</span><span class="op">[</span><span class="op">-</span><span class="va">n</span><span class="op">]</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>item <span class="op">=</span> <span class="va">item</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>This leads to rather awkward usage:</p>
<div class="sourceCode" id="cb661"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">new_stack</span><span class="op">(</span><span class="op">)</span>
<span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">push</span><span class="op">(</span><span class="va">s</span>, <span class="fl">10</span><span class="op">)</span>
<span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">push</span><span class="op">(</span><span class="va">s</span>, <span class="fl">20</span><span class="op">)</span>

<span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">pop</span><span class="op">(</span><span class="va">s</span><span class="op">)</span>
<span class="va">out</span><span class="op">$</span><span class="va">item</span>
<span class="co">#&gt; [1] 20</span>
<span class="va">s</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">x</span>
<span class="va">s</span>
<span class="co">#&gt; $items</span>
<span class="co">#&gt; $items[[1]]</span>
<span class="co">#&gt; [1] 10</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attr(,"class")</span>
<span class="co">#&gt; [1] "stack"</span></code></pre></div>
<p>This problem is known as <strong>threading state</strong> or <strong>accumulator programming</strong>, because no matter how deeply the <code>pop()</code> is called, you have to thread the modified stack object all the way back to where it lives.</p>
<p>

One way that other FP languages deal with this challenge is to provide a <strong>multiple assign</strong> (or destructuring bind) operator that allows you to assign multiple values in a single step. The zeallot package<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Nathan Teetor, &lt;em&gt;Zeallot: Multiple, Unpacking, and Destructuring Assignment&lt;/em&gt;, 2018, &lt;a href="https://CRAN.R-project.org/package=zeallot" role="doc-biblioref"&gt;https://CRAN.R-project.org/package=zeallot&lt;/a&gt;.&lt;/p&gt;'><sup>83</sup></a></span> provides multi-assign for R with <code>%&lt;-%</code>. This makes the code more elegant, but doesn’t solve the key problem:</p>
<div class="sourceCode" id="cb662"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nteetor/zeallot">zeallot</a></span><span class="op">)</span>
<span class="co">#&gt; Warning: package 'zeallot' was built under R version 4.1.2</span>

<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">value</span>, <span class="va">s</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/zeallot/man/operator.html">%&lt;-%</a></span> <span class="fu">pop</span><span class="op">(</span><span class="va">s</span><span class="op">)</span>
<span class="va">value</span>
<span class="co">#&gt; [1] 10</span></code></pre></div>
<p>An R6 implementation of a stack is simpler because <code>$pop()</code> can modify the object in place, and return only the top-most value:</p>
<div class="sourceCode" id="cb663"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Stack</span> <span class="op">&lt;-</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"Stack"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  items <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>,
  push <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">self</span><span class="op">$</span><span class="va">items</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">items</span>, <span class="va">x</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="va">self</span><span class="op">)</span>
  <span class="op">}</span>,
  pop <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">item</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">items</span><span class="op">[[</span><span class="va">self</span><span class="op">$</span><span class="fu">length</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>
    <span class="va">self</span><span class="op">$</span><span class="va">items</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">items</span><span class="op">[</span><span class="op">-</span><span class="va">self</span><span class="op">$</span><span class="fu">length</span><span class="op">(</span><span class="op">)</span><span class="op">]</span>
    <span class="va">item</span>
  <span class="op">}</span>,
  length <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">items</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<p>This leads to more natural code:</p>
<div class="sourceCode" id="cb664"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span> <span class="op">&lt;-</span> <span class="va">Stack</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">s</span><span class="op">$</span><span class="fu">push</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">s</span><span class="op">$</span><span class="fu">push</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>
<span class="va">s</span><span class="op">$</span><span class="fu">pop</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] 20</span></code></pre></div>
<p>I encountered a real-life example of threading state in ggplot2 scales. Scales are complex because they need to combine data across every facet and every layer. I originally used S3 classes, but it required passing scale data to and from many functions. Switching to R6 made the code substantially simpler. However, it also introduced some problems because I forgot to call to <code>$clone()</code> when modifying a plot. This allowed independent plots to share the same scale data, creating a subtle bug that was hard to track down.</p>
</div>
<div id="tradeoffs-pipe" class="section level3" number="16.3.3">
<h3>
<span class="header-section-number">16.3.3</span> Method chaining<a class="anchor" aria-label="anchor" href="#tradeoffs-pipe"><i class="fas fa-link"></i></a>
</h3>
<p>
</p>
<p>The pipe, <code>%&gt;%</code>, is useful because it provides an infix operator that makes it easy to compose functions from left-to-right. Interestingly, the pipe is not so important for R6 objects because they already use an infix operator: <code>$</code>. This allows the user to chain together multiple method calls in a single expression, a technique known as <strong>method chaining</strong>:</p>
<div class="sourceCode" id="cb665"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span> <span class="op">&lt;-</span> <span class="va">Stack</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">s</span><span class="op">$</span>
  <span class="fu">push</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">push</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">$</span>
  <span class="fu">pop</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] 20</span></code></pre></div>
<p>This technique is commonly used in other programming languages, like Python and JavaScript, and is made possible with one convention: any R6 method that is primarily called for its side-effects (usually modifying the object) should return <code>invisible(self)</code>.</p>
<p>The primary advantage of method chaining is that you can get useful autocomplete; the primary disadvantage is that only the creator of the class can add new methods (and there’s no way to use multiple dispatch).</p>

</div>
</div>
</div>




  <div class="chapter-nav">
<div class="prev"><a href="s4.html"><span class="header-section-number">15</span> S4</a></div>
<div class="next"><a href="metaprogramming.html">Introduction</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#oo-tradeoffs"><span class="header-section-number">16</span> Trade-offs</a></li>
<li>
<a class="nav-link" href="#introduction-15"><span class="header-section-number">16.1</span> Introduction</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#outline-14">Outline</a></li>
<li><a class="nav-link" href="#prerequisites-9">Prerequisites</a></li>
</ul>
</li>
<li><a class="nav-link" href="#s3-s4"><span class="header-section-number">16.2</span> S4 versus S3</a></li>
<li>
<a class="nav-link" href="#s3-r6"><span class="header-section-number">16.3</span> R6 versus S3</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#namespacing"><span class="header-section-number">16.3.1</span> Namespacing</a></li>
<li><a class="nav-link" href="#threading-state"><span class="header-section-number">16.3.2</span> Threading state</a></li>
<li><a class="nav-link" href="#tradeoffs-pipe"><span class="header-section-number">16.3.3</span> Method chaining</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/hadley/adv-r/blob/master/OO-tradeoffs.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/hadley/adv-r/edit/master/OO-tradeoffs.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R avanzado</strong>" was written by Jeshua Romero Guadarrama. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
