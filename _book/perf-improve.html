<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>24 Improving performance | R avanzado</title>
<meta name="author" content="Jeshua Romero Guadarrama">
<meta name="generator" content="bookdown 0.24.4 with bs4_book()">
<meta property="og:title" content="24 Improving performance | R avanzado">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="24 Improving performance | R avanzado">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1.9000/transition.js"></script><script src="libs/bs3compat-0.3.1.9000/tabs.js"></script><script src="libs/bs3compat-0.3.1.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141212623-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-141212623-1');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><meta name="description" content="24.1 Introduction  We should forget about small efficiencies, say about 97% of the time: premature optimization is the root of all evil. Yet we should not pass up our opportunities in that...">
<meta property="og:description" content="24.1 Introduction  We should forget about small efficiencies, say about 97% of the time: premature optimization is the root of all evil. Yet we should not pass up our opportunities in that...">
<meta name="twitter:description" content="24.1 Introduction  We should forget about small efficiencies, say about 97% of the time: premature optimization is the root of all evil. Yet we should not pass up our opportunities in that...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R avanzado</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li class="book-part">Foundations</li>
<li><a class="" href="foundations-intro.html">Introduction</a></li>
<li><a class="" href="names-values.html"><span class="header-section-number">2</span> Names and values</a></li>
<li><a class="" href="vectors-chap.html"><span class="header-section-number">3</span> Vectors</a></li>
<li><a class="" href="subsetting.html"><span class="header-section-number">4</span> Subsetting</a></li>
<li><a class="" href="control-flow.html"><span class="header-section-number">5</span> Control flow</a></li>
<li><a class="" href="functions.html"><span class="header-section-number">6</span> Functions</a></li>
<li><a class="" href="environments.html"><span class="header-section-number">7</span> Environments</a></li>
<li><a class="" href="conditions.html"><span class="header-section-number">8</span> Conditions</a></li>
<li class="book-part">Functional programming</li>
<li><a class="" href="fp.html">Introduction</a></li>
<li><a class="" href="functionals.html"><span class="header-section-number">9</span> Functionals</a></li>
<li><a class="" href="function-factories.html"><span class="header-section-number">10</span> Function factories</a></li>
<li><a class="" href="function-operators.html"><span class="header-section-number">11</span> Function operators</a></li>
<li class="book-part">Object-oriented programming</li>
<li><a class="" href="oo.html">Introduction</a></li>
<li><a class="" href="base-types.html"><span class="header-section-number">12</span> Base types</a></li>
<li><a class="" href="s3.html"><span class="header-section-number">13</span> S3</a></li>
<li><a class="" href="r6.html"><span class="header-section-number">14</span> R6</a></li>
<li><a class="" href="s4.html"><span class="header-section-number">15</span> S4</a></li>
<li><a class="" href="oo-tradeoffs.html"><span class="header-section-number">16</span> Trade-offs</a></li>
<li class="book-part">Metaprogramming</li>
<li><a class="" href="metaprogramming.html">Introduction</a></li>
<li><a class="" href="meta-big-picture.html"><span class="header-section-number">17</span> Big picture</a></li>
<li><a class="" href="expressions.html"><span class="header-section-number">18</span> Expressions</a></li>
<li><a class="" href="quasiquotation.html"><span class="header-section-number">19</span> Quasiquotation</a></li>
<li><a class="" href="evaluation.html"><span class="header-section-number">20</span> Evaluation</a></li>
<li><a class="" href="translation.html"><span class="header-section-number">21</span> Translating R code</a></li>
<li class="book-part">Techniques</li>
<li><a class="" href="techniques.html">Introduction</a></li>
<li><a class="" href="debugging.html"><span class="header-section-number">22</span> Debugging</a></li>
<li><a class="" href="perf-measure.html"><span class="header-section-number">23</span> Measuring performance</a></li>
<li><a class="active" href="perf-improve.html"><span class="header-section-number">24</span> Improving performance</a></li>
<li><a class="" href="rcpp.html"><span class="header-section-number">25</span> Rewriting R code in C++</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/hadley/adv-r">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="perf-improve" class="section level1" number="24">
<h1>
<span class="header-section-number">24</span> Improving performance<a class="anchor" aria-label="anchor" href="#perf-improve"><i class="fas fa-link"></i></a>
</h1>
<div id="introduction-23" class="section level2" number="24.1">
<h2>
<span class="header-section-number">24.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-23"><i class="fas fa-link"></i></a>
</h2>
<p></p>
<blockquote>
<p>We should forget about small efficiencies, say about 97% of the time:
premature optimization is the root of all evil. Yet we should not pass up our
opportunities in that critical 3%. A good programmer will not be lulled
into complacency by such reasoning, he will be wise to look carefully at
the critical code; but only after that code has been identified.</p>
<p>— Donald Knuth</p>
</blockquote>
<p>Once you’ve used profiling to identify a bottleneck, you need to make it faster. It’s difficult to provide general advice on improving performance, but I try my best with four techniques that can be applied in many situations. I’ll also suggest a general strategy for performance optimisation that helps ensure that your faster code is still correct.</p>
<p>It’s easy to get caught up in trying to remove all bottlenecks. Don’t! Your time is valuable and is better spent analysing your data, not eliminating possible inefficiencies in your code. Be pragmatic: don’t spend hours of your time to save seconds of computer time. To enforce this advice, you should set a goal time for your code and optimise only up to that goal. This means you will not eliminate all bottlenecks. Some you will not get to because you’ve met your goal. Others you may need to pass over and accept either because there is no quick and easy solution or because the code is already well optimised and no significant improvement is possible. Accept these possibilities and move on to the next candidate.</p>
<p>If you’d like to learn more about the performance characteristics of the R language, I’d highly recommend <em>Evaluating the Design of the R Language</em>.<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Floréal Morandat et al., &lt;span&gt;“Evaluating the Design of the &lt;span&gt;R&lt;/span&gt; Language,”&lt;/span&gt; in &lt;em&gt;European Conference on Object-Oriented Programming&lt;/em&gt; (Springer, 2012), 104–31, &lt;a href="http://r.cs.purdue.edu/pub/ecoop12.pdf" role="doc-biblioref"&gt;http://r.cs.purdue.edu/pub/ecoop12.pdf&lt;/a&gt;.&lt;/p&gt;'><sup>111</sup></a></span> It draws conclusions by combining a modified R interpreter with a wide set of code found in the wild.</p>
<div id="outline-22" class="section level3 unnumbered">
<h3>Outline<a class="anchor" aria-label="anchor" href="#outline-22"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>Section <a href="perf-improve.html#code-organisation">24.2</a> teaches you how to organise
your code to make optimisation as easy, and bug free, as possible.</p></li>
<li><p>Section <a href="perf-improve.html#already-solved">24.3</a> reminds you to look for existing
solutions.</p></li>
<li><p>Section <a href="perf-improve.html#be-lazy">24.4</a> emphasises the importance of
being lazy: often the easiest way to make a function faster is to
let it to do less work.</p></li>
<li><p>Section <a href="perf-improve.html#vectorise">24.5</a> concisely defines vectorisation, and shows you
how to make the most of built-in functions.</p></li>
<li><p>Section <a href="perf-improve.html#avoid-copies">24.6</a> discusses the performance perils of
copying data.</p></li>
<li><p>Section <a href="perf-improve.html#t-test">24.7</a> pulls all the pieces together into a case
study showing how to speed up repeated t-tests by about a thousand times.</p></li>
<li><p>Section <a href="perf-improve.html#more-techniques">24.8</a> finishes the chapter with pointers to
more resources that will help you write fast code.</p></li>
</ul>
</div>
<div id="prerequisites-16" class="section level3 unnumbered">
<h3>Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites-16"><i class="fas fa-link"></i></a>
</h3>
<p>We’ll use <a href="https://bench.r-lib.org/">bench</a> to precisely compare the performance of small self-contained code chunks.</p>
<div class="sourceCode" id="cb983"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/bench">bench</a></span><span class="op">)</span>
<span class="co">#&gt; Warning: package 'bench' was built under R version 4.1.2</span></code></pre></div>
</div>
</div>
<div id="code-organisation" class="section level2" number="24.2">
<h2>
<span class="header-section-number">24.2</span> Code organisation<a class="anchor" aria-label="anchor" href="#code-organisation"><i class="fas fa-link"></i></a>
</h2>
<p></p>
<p>There are two traps that are easy to fall into when trying to make your code faster:</p>
<ol style="list-style-type: decimal">
<li>Writing faster but incorrect code.</li>
<li>Writing code that you think is faster, but is actually no better.</li>
</ol>
<p>The strategy outlined below will help you avoid these pitfalls.</p>
<p>When tackling a bottleneck, you’re likely to come up with multiple approaches. Write a function for each approach, encapsulating all relevant behaviour. This makes it easier to check that each approach returns the correct result and to time how long it takes to run. To demonstrate the strategy, I’ll compare two approaches for computing the mean:</p>
<div class="sourceCode" id="cb984"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mean1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="va">mean2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></code></pre></div>
<p>I recommend that you keep a record of everything you try, even the failures. If a similar problem occurs in the future, it’ll be useful to see everything you’ve tried. To do this I recommend RMarkdown, which makes it easy to intermingle code with detailed comments and notes.</p>
<p>Next, generate a representative test case. The case should be big enough to capture the essence of your problem but small enough that it only takes a few seconds at most. You don’t want it to take too long because you’ll need to run the test case many times to compare approaches. On the other hand, you don’t want the case to be too small because then results might not scale up to the real problem. Here I’m going to use 100,000 numbers:</p>
<div class="sourceCode" id="cb985"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1e5</span><span class="op">)</span></code></pre></div>
<p>Now use <code><a href="https://rdrr.io/pkg/bench/man/mark.html">bench::mark()</a></code> to precisely compare the variations. <code><a href="https://rdrr.io/pkg/bench/man/mark.html">bench::mark()</a></code> automatically checks that all calls return the same values. This doesn’t guarantee that the function behaves the same for all inputs, so in an ideal world you’ll also have unit tests to make sure you don’t accidentally change the behaviour of the function.</p>
<div class="sourceCode" id="cb986"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
  <span class="fu">mean1</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,
  <span class="fu">mean2</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expression"</span>, <span class="st">"min"</span>, <span class="st">"median"</span>, <span class="st">"itr/sec"</span>, <span class="st">"n_gc"</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 2 x 4</span>
<span class="co">#&gt;   expression      min   median `itr/sec`</span>
<span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 mean1(x)      424us    760us      654.</span>
<span class="co">#&gt; 2 mean2(x)      180us    203us     2583.</span></code></pre></div>
<p>(You might be surprised by the results: <code>mean(x)</code> is considerably slower than <code>sum(x) / length(x)</code>. This is because, among other reasons, <code>mean(x)</code> makes two passes over the vector to be more numerically accurate.)</p>
<p>If you’d like to see this strategy in action, I’ve used it a few times on stackoverflow:</p>
<ul>
<li><a href="http://stackoverflow.com/questions/22515525#22518603" class="uri">http://stackoverflow.com/questions/22515525#22518603</a></li>
<li><a href="http://stackoverflow.com/questions/22515175#22515856" class="uri">http://stackoverflow.com/questions/22515175#22515856</a></li>
<li><a href="http://stackoverflow.com/questions/3476015#22511936" class="uri">http://stackoverflow.com/questions/3476015#22511936</a></li>
</ul>
</div>
<div id="already-solved" class="section level2" number="24.3">
<h2>
<span class="header-section-number">24.3</span> Checking for existing solutions<a class="anchor" aria-label="anchor" href="#already-solved"><i class="fas fa-link"></i></a>
</h2>
<p>Once you’ve organised your code and captured all the variations you can think of, it’s natural to see what others have done. You are part of a large community, and it’s quite possible that someone has already tackled the same problem. Two good places to start are:</p>
<ul>
<li><p><a href="http://cran.rstudio.com/web/views/">CRAN task views</a>. If there’s a
CRAN task view related to your problem domain, it’s worth looking at
the packages listed there.</p></li>
<li><p>Reverse dependencies of Rcpp, as listed on its
<a href="http://cran.r-project.org/web/packages/Rcpp">CRAN page</a>. Since these
packages use C++, they’re likely to be fast.</p></li>
</ul>
<p>Otherwise, the challenge is describing your bottleneck in a way that helps you find related problems and solutions. Knowing the name of the problem or its synonyms will make this search much easier. But because you don’t know what it’s called, it’s hard to search for it! The best way to solve this problem is to read widely so that you can build up your own vocabulary over time. Alternatively, ask others. Talk to your colleagues and brainstorm some possible names, then search on Google and StackOverflow. It’s often helpful to restrict your search to R related pages. For Google, try <a href="http://www.rseek.org/">rseek</a>. For stackoverflow, restrict your search by including the R tag, <code>[R]</code>, in your search.</p>
<p>Record all solutions that you find, not just those that immediately appear to be faster. Some solutions might be slower initially, but end up being faster because they’re easier to optimise. You may also be able to combine the fastest parts from different approaches. If you’ve found a solution that’s fast enough, congratulations! Otherwise, read on.</p>
<div id="exercises-70" class="section level3" number="24.3.1">
<h3>
<span class="header-section-number">24.3.1</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-70"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>What are faster alternatives to <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>? Which are specifically designed
to work with larger datasets?</p></li>
<li><p>What package implements a version of <code><a href="https://rdrr.io/r/base/match.html">match()</a></code> that’s faster for
repeated lookups? How much faster is it?</p></li>
<li><p>List four functions (not just those in base R) that convert a string into a
date time object. What are their strengths and weaknesses?</p></li>
<li><p>Which packages provide the ability to compute a rolling mean?</p></li>
<li><p>What are the alternatives to <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code>?</p></li>
</ol>
</div>
</div>
<div id="be-lazy" class="section level2" number="24.4">
<h2>
<span class="header-section-number">24.4</span> Doing as little as possible<a class="anchor" aria-label="anchor" href="#be-lazy"><i class="fas fa-link"></i></a>
</h2>
<p>The easiest way to make a function faster is to let it do less work. One way to do that is use a function tailored to a more specific type of input or output, or to a more specific problem. For example:</p>
<ul>
<li><p><code><a href="https://rdrr.io/r/base/colSums.html">rowSums()</a></code>, <code><a href="https://rdrr.io/r/base/colSums.html">colSums()</a></code>, <code><a href="https://rdrr.io/r/base/colSums.html">rowMeans()</a></code>, and <code><a href="https://rdrr.io/r/base/colSums.html">colMeans()</a></code> are faster than
equivalent invocations that use <code><a href="https://rdrr.io/r/base/apply.html">apply()</a></code> because they are vectorised
(Section <a href="perf-improve.html#vectorise">24.5</a>).</p></li>
<li><p><code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code> is faster than <code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code> because it pre-specifies the output
type.</p></li>
<li><p>If you want to see if a vector contains a single value, <code>any(x == 10)</code>
is much faster than <code>10 %in% x</code> because testing equality is simpler
than testing set inclusion.</p></li>
</ul>
<p>Having this knowledge at your fingertips requires knowing that alternative functions exist: you need to have a good vocabulary. Expand your vocab by regularly reading R code. Good places to read code are the <a href="https://stat.ethz.ch/mailman/listinfo/r-help">R-help mailing list</a> and <a href="http://stackoverflow.com/questions/tagged/r">StackOverflow</a>.</p>
<p>Some functions coerce their inputs into a specific type. If your input is not the right type, the function has to do extra work. Instead, look for a function that works with your data as it is, or consider changing the way you store your data. The most common example of this problem is using <code><a href="https://rdrr.io/r/base/apply.html">apply()</a></code> on a data frame. <code><a href="https://rdrr.io/r/base/apply.html">apply()</a></code> always turns its input into a matrix. Not only is this error prone (because a data frame is more general than a matrix), it is also slower.</p>
<p>Other functions will do less work if you give them more information about the problem. It’s always worthwhile to carefully read the documentation and experiment with different arguments. Some examples that I’ve discovered in the past include:</p>
<ul>
<li><p><code><a href="https://rdrr.io/r/utils/read.table.html">read.csv()</a></code>: specify known column types with <code>colClasses</code>. (Also consider
switching to <code><a href="https://readr.tidyverse.org/reference/read_delim.html">readr::read_csv()</a></code> or <code><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html">data.table::fread()</a></code> which are
considerably faster than <code><a href="https://rdrr.io/r/utils/read.table.html">read.csv()</a></code>.)</p></li>
<li><p><code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code>: specify known levels with <code>levels</code>.</p></li>
<li><p><code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code>: don’t generate labels with <code>labels = FALSE</code> if you don’t need them,
or, even better, use <code><a href="https://rdrr.io/r/base/findInterval.html">findInterval()</a></code> as mentioned in the “see also” section
of the documentation.</p></li>
<li><p><code>unlist(x, use.names = FALSE)</code> is much faster than <code>unlist(x)</code>.</p></li>
<li><p><code><a href="https://rdrr.io/r/base/interaction.html">interaction()</a></code>: if you only need combinations that exist in the data, use
<code>drop = TRUE</code>.</p></li>
</ul>
<p>Below, I explore how you might improve apply this strategy to improve the performance of <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> and <code><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame()</a></code>.</p>
<div id="mean" class="section level3" number="24.4.1">
<h3>
<span class="header-section-number">24.4.1</span> <code>mean()</code><a class="anchor" aria-label="anchor" href="#mean"><i class="fas fa-link"></i></a>
</h3>
<p></p>
<p>Sometimes you can make a function faster by avoiding method dispatch. If you’re calling a method in a tight loop, you can avoid some of the costs by doing the method lookup only once:</p>
<ul>
<li><p>For S3, you can do this by calling <code>generic.class()</code> instead of <code>generic()</code>.</p></li>
<li><p>For S4, you can do this by using <code><a href="https://rdrr.io/r/methods/getMethod.html">selectMethod()</a></code> to find the method, saving
it to a variable, and then calling that function.</p></li>
</ul>
<p>For example, calling <code><a href="https://rdrr.io/r/base/mean.html">mean.default()</a></code> is quite a bit faster than calling <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> for small vectors:</p>
<div class="sourceCode" id="cb987"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1e2</span><span class="op">)</span>

<span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean.default</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expression"</span>, <span class="st">"min"</span>, <span class="st">"median"</span>, <span class="st">"itr/sec"</span>, <span class="st">"n_gc"</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 2 x 4</span>
<span class="co">#&gt;   expression           min   median `itr/sec`</span>
<span class="co">#&gt;   &lt;bch:expr&gt;      &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 mean(x)              6us    7.1us    53463.</span>
<span class="co">#&gt; 2 mean.default(x)    3.1us    3.8us    31441.</span></code></pre></div>
<p>This optimisation is a little risky. While <code><a href="https://rdrr.io/r/base/mean.html">mean.default()</a></code> is almost twice as fast for 100 values, it will fail in surprising ways if <code>x</code> is not a numeric vector.</p>
<p>An even riskier optimisation is to directly call the underlying <code>.Internal</code> function. This is faster because it doesn’t do any input checking or handle NA’s, so you are buying speed at the cost of safety.</p>
<div class="sourceCode" id="cb988"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1e2</span><span class="op">)</span>
<span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean.default</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/Internal.html">.Internal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expression"</span>, <span class="st">"min"</span>, <span class="st">"median"</span>, <span class="st">"itr/sec"</span>, <span class="st">"n_gc"</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 3 x 4</span>
<span class="co">#&gt;   expression              min   median `itr/sec`</span>
<span class="co">#&gt;   &lt;bch:expr&gt;         &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 mean(x)                 6us    7.4us   108559.</span>
<span class="co">#&gt; 2 mean.default(x)       3.1us    3.9us   213854.</span>
<span class="co">#&gt; 3 .Internal(mean(x))    800ns    1.1us   811405.</span></code></pre></div>
<p>NB: Most of these differences arise because <code>x</code> is small. If you increase the size the differences basically disappear, because most of the time is now spent computing the mean, not finding the underlying implementation. This is a good reminder that the size of the input matters, and you should motivate your optimisations based on realistic data.</p>
<div class="sourceCode" id="cb989"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1e4</span><span class="op">)</span>
<span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean.default</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/Internal.html">.Internal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expression"</span>, <span class="st">"min"</span>, <span class="st">"median"</span>, <span class="st">"itr/sec"</span>, <span class="st">"n_gc"</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 3 x 4</span>
<span class="co">#&gt;   expression              min   median `itr/sec`</span>
<span class="co">#&gt;   &lt;bch:expr&gt;         &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 mean(x)              40.7us   44.8us    20705.</span>
<span class="co">#&gt; 2 mean.default(x)      37.3us     41us    22311.</span>
<span class="co">#&gt; 3 .Internal(mean(x))   35.1us   44.9us    18493.</span></code></pre></div>
</div>
<div id="as.data.frame" class="section level3" number="24.4.2">
<h3>
<span class="header-section-number">24.4.2</span> <code>as.data.frame()</code><a class="anchor" aria-label="anchor" href="#as.data.frame"><i class="fas fa-link"></i></a>
</h3>
<p>Knowing that you’re dealing with a specific type of input can be another way to write faster code. For example, <code><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame()</a></code> is quite slow because it coerces each element into a data frame and then <code><a href="https://rdrr.io/r/base/cbind.html">rbind()</a></code>s them together. If you have a named list with vectors of equal length, you can directly transform it into a data frame. In this case, if you can make strong assumptions about your input, you can write a method that’s considerably faster than the default.</p>
<div class="sourceCode" id="cb990"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">quickdf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"data.frame"</span>
  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">l</span>, <span class="st">"row.names"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/base-internal.html">.set_row_names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">l</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
  <span class="va">l</span>
<span class="op">}</span>

<span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">26</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1e3</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">letters</span>

<span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
  as.data.frame <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span>,
  quick_df      <span class="op">=</span> <span class="fu">quickdf</span><span class="op">(</span><span class="va">l</span><span class="op">)</span>
<span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expression"</span>, <span class="st">"min"</span>, <span class="st">"median"</span>, <span class="st">"itr/sec"</span>, <span class="st">"n_gc"</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 2 x 4</span>
<span class="co">#&gt;   expression         min   median `itr/sec`</span>
<span class="co">#&gt;   &lt;bch:expr&gt;    &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 as.data.frame   2.73ms   3.15ms      279.</span>
<span class="co">#&gt; 2 quick_df        17.1us   21.5us    33201.</span></code></pre></div>
<p>Again, note the trade-off. This method is fast because it’s dangerous. If you give it bad inputs, you’ll get a corrupt data frame:</p>
<div class="sourceCode" id="cb991"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">quickdf</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span>, y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning in format.data.frame(if (omit) x[seq_len(n0), , drop = FALSE] else x, :</span>
<span class="co">#&gt; corrupt data frame: columns will be truncated or padded with NAs</span>
<span class="co">#&gt;   x y</span>
<span class="co">#&gt; 1 1 1</span></code></pre></div>
<p>To come up with this minimal method, I carefully read through and then rewrote the source code for <code><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame.list()</a></code> and <code><a href="https://rdrr.io/r/base/data.frame.html">data.frame()</a></code>. I made many small changes, each time checking that I hadn’t broken existing behaviour. After several hours work, I was able to isolate the minimal code shown above. This is a very useful technique. Most base R functions are written for flexibility and functionality, not performance. Thus, rewriting for your specific need can often yield substantial improvements. To do this, you’ll need to read the source code. It can be complex and confusing, but don’t give up!</p>
</div>
<div id="exercises-71" class="section level3" number="24.4.3">
<h3>
<span class="header-section-number">24.4.3</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-71"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>What’s the difference between <code><a href="https://rdrr.io/r/base/colSums.html">rowSums()</a></code> and <code><a href="https://rdrr.io/r/base/colSums.html">.rowSums()</a></code>?</p></li>
<li><p>Make a faster version of <code><a href="https://rdrr.io/r/stats/chisq.test.html">chisq.test()</a></code> that only computes the chi-square
test statistic when the input is two numeric vectors with no missing
values. You can try simplifying <code><a href="https://rdrr.io/r/stats/chisq.test.html">chisq.test()</a></code> or by coding from the
<a href="http://en.wikipedia.org/wiki/Pearson%27s_chi-squared_test">mathematical definition</a>.</p></li>
<li><p>Can you make a faster version of <code><a href="https://rdrr.io/r/base/table.html">table()</a></code> for the case of an input of
two integer vectors with no missing values? Can you use it to
speed up your chi-square test?</p></li>
</ol>
</div>
</div>
<div id="vectorise" class="section level2" number="24.5">
<h2>
<span class="header-section-number">24.5</span> Vectorise<a class="anchor" aria-label="anchor" href="#vectorise"><i class="fas fa-link"></i></a>
</h2>
<p></p>
<p>If you’ve used R for any length of time, you’ve probably heard the admonishment to “vectorise your code.” But what does that actually mean? Vectorising your code is not just about avoiding for loops, although that’s often a step. Vectorising is about taking a whole-object approach to a problem, thinking about vectors, not scalars. There are two key attributes of a vectorised function:</p>
<ul>
<li><p>It makes many problems simpler. Instead of having to think about the
components of a vector, you only think about entire vectors.</p></li>
<li><p>The loops in a vectorised function are written in C instead of R. Loops in C
are much faster because they have much less overhead.</p></li>
</ul>
<p>Chapter <a href="functionals.html#functionals">9</a> stressed the importance of vectorised code as a higher level abstraction. Vectorisation is also important for writing fast R code. This doesn’t mean simply using <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> or <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code>. Instead, vectorisation means finding the existing R function that is implemented in C and most closely applies to your problem.</p>
<p>Vectorised functions that apply to many common performance bottlenecks include:</p>
<ul>
<li>
<p><code><a href="https://rdrr.io/r/base/colSums.html">rowSums()</a></code>, <code><a href="https://rdrr.io/r/base/colSums.html">colSums()</a></code>, <code><a href="https://rdrr.io/r/base/colSums.html">rowMeans()</a></code>, and <code><a href="https://rdrr.io/r/base/colSums.html">colMeans()</a></code>. These vectorised
matrix functions will always be faster than using <code><a href="https://rdrr.io/r/base/apply.html">apply()</a></code>. You can
sometimes use these functions to build other vectorised functions.</p>
<div class="sourceCode" id="cb992"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rowAny</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>
<span class="va">rowAll</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></code></pre></div>
</li>
<li><p>Vectorised subsetting can lead to big improvements in speed. Remember the
techniques behind lookup tables (Section <a href="subsetting.html#lookup-tables">4.5.1</a>) and matching
and merging by hand (Section <a href="subsetting.html#matching-merging">4.5.2</a>). Also
remember that you can use subsetting assignment to replace multiple values in
a single step. If <code>x</code> is a vector, matrix or data frame then
<code>x[is.na(x)] &lt;- 0</code> will replace all missing values with 0.</p></li>
<li><p>If you’re extracting or replacing values in scattered locations in a matrix
or data frame, subset with an integer matrix.
See Section <a href="subsetting.html#matrix-subsetting">4.2.3</a> for more details.</p></li>
<li><p>If you’re converting continuous values to categorical make sure you know
how to use <code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> and <code><a href="https://rdrr.io/r/base/findInterval.html">findInterval()</a></code>.</p></li>
<li><p>Be aware of vectorised functions like <code><a href="https://rdrr.io/r/base/cumsum.html">cumsum()</a></code> and <code><a href="https://rdrr.io/r/base/diff.html">diff()</a></code>.</p></li>
</ul>
<p>Matrix algebra is a general example of vectorisation. There loops are executed by highly tuned external libraries like BLAS. If you can figure out a way to use matrix algebra to solve your problem, you’ll often get a very fast solution. The ability to solve problems with matrix algebra is a product of experience. A good place to start is to ask people with experience in your domain.</p>
<p>Vectorisation has a downside: it is harder to predict how operations will scale. The following example measures how long it takes to use character subsetting to look up 1, 10, and 100 elements from a list. You might expect that looking up 10 elements would take 10 times as long as looking up 1, and that looking up 100 elements would take 10 times longer again. In fact, the following example shows that it only takes about ~10x longer to look up 100 elements than it does to look up 1. That happens because once you get to a certain size, the internal implementation switches to a strategy that has a higher set up cost, but scales better.</p>
<div class="sourceCode" id="cb993"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lookup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">26</span><span class="op">)</span><span class="op">)</span>, <span class="va">letters</span><span class="op">)</span>

<span class="va">x1</span> <span class="op">&lt;-</span> <span class="st">"j"</span>
<span class="va">x10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span>, <span class="fl">10</span><span class="op">)</span>
<span class="va">x100</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
  <span class="va">lookup</span><span class="op">[</span><span class="va">x1</span><span class="op">]</span>,
  <span class="va">lookup</span><span class="op">[</span><span class="va">x10</span><span class="op">]</span>,
  <span class="va">lookup</span><span class="op">[</span><span class="va">x100</span><span class="op">]</span>,
  check <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expression"</span>, <span class="st">"min"</span>, <span class="st">"median"</span>, <span class="st">"itr/sec"</span>, <span class="st">"n_gc"</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 3 x 4</span>
<span class="co">#&gt;   expression        min   median `itr/sec`</span>
<span class="co">#&gt;   &lt;bch:expr&gt;   &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 lookup[x1]      1.3us    1.8us   442984.</span>
<span class="co">#&gt; 2 lookup[x10]     2.8us    3.6us   216607.</span>
<span class="co">#&gt; 3 lookup[x100]    5.9us    9.7us    97707.</span></code></pre></div>
<p>Vectorisation won’t solve every problem, and rather than torturing an existing algorithm into one that uses a vectorised approach, you’re often better off writing your own vectorised function in C++. You’ll learn how to do so in Chapter <a href="rcpp.html#rcpp">25</a>.</p>
<div id="exercises-72" class="section level3" number="24.5.1">
<h3>
<span class="header-section-number">24.5.1</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-72"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>The density functions, e.g., <code><a href="https://rdrr.io/r/stats/Normal.html">dnorm()</a></code>, have a common interface. Which
arguments are vectorised over? What does <code>rnorm(10, mean = 10:1)</code> do?</p></li>
<li><p>Compare the speed of <code>apply(x, 1, sum)</code> with <code>rowSums(x)</code> for varying sizes
of <code>x</code>.</p></li>
<li><p>How can you use <code><a href="https://rdrr.io/r/base/crossprod.html">crossprod()</a></code> to compute a weighted sum? How much faster is
it than the naive <code>sum(x * w)</code>?</p></li>
</ol>
</div>
</div>
<div id="avoid-copies" class="section level2" number="24.6">
<h2>
<span class="header-section-number">24.6</span> Avoiding copies<a class="anchor" aria-label="anchor" href="#avoid-copies"><i class="fas fa-link"></i></a>
</h2>
<p>
</p>
<p>A pernicious source of slow R code is growing an object with a loop. Whenever you use <code><a href="https://rdrr.io/r/base/c.html">c()</a></code>, <code><a href="https://rdrr.io/r/base/append.html">append()</a></code>, <code><a href="https://rdrr.io/r/base/cbind.html">cbind()</a></code>, <code><a href="https://rdrr.io/r/base/cbind.html">rbind()</a></code>, or <code><a href="https://rdrr.io/r/base/paste.html">paste()</a></code> to create a bigger object, R must first allocate space for the new object and then copy the old object to its new home. If you’re repeating this many times, like in a for loop, this can be quite expensive. You’ve entered Circle 2 of the <a href="http://www.burns-stat.com/pages/Tutor/R_inferno.pdf"><em>R inferno</em></a>.</p>
<p>You saw one example of this type of problem in Section <a href="perf-measure.html#memory-profiling">23.2.2</a>, so here I’ll show a slightly more complex example of the same basic issue. We first generate some random strings, and then combine them either iteratively with a loop using <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collapse()</a></code>, or in a single pass using <code><a href="https://rdrr.io/r/base/paste.html">paste()</a></code>. Note that the performance of <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collapse()</a></code> gets relatively worse as the number of strings grows: combining 100 strings takes almost 30 times longer than combining 10 strings.</p>
<div class="sourceCode" id="cb994"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">random_string</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">letters</span>, <span class="fl">50</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">strings10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu">random_string</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">strings100</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fu">random_string</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">collapse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">xs</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">out</span> <span class="op">&lt;-</span> <span class="st">""</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">xs</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">x</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">out</span>
<span class="op">}</span>

<span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
  loop10  <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collapse</a></span><span class="op">(</span><span class="va">strings10</span><span class="op">)</span>,
  loop100 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collapse</a></span><span class="op">(</span><span class="va">strings100</span><span class="op">)</span>,
  vec10   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">strings10</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,
  vec100  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">strings100</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,
  check <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"expression"</span>, <span class="st">"min"</span>, <span class="st">"median"</span>, <span class="st">"itr/sec"</span>, <span class="st">"n_gc"</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 4 x 4</span>
<span class="co">#&gt;   expression      min   median `itr/sec`</span>
<span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 loop10       44.3us   54.8us    17031.</span>
<span class="co">#&gt; 2 loop100      1.23ms   1.63ms      418.</span>
<span class="co">#&gt; 3 vec10        10.4us   12.4us    48685.</span>
<span class="co">#&gt; 4 vec100       49.2us     66us    11888.</span></code></pre></div>
<p>Modifying an object in a loop, e.g., <code>x[i] &lt;- y</code>, can also create a copy, depending on the class of <code>x</code>. Section <a href="names-values.html#single-binding">2.5.1</a> discusses this issue in more depth and gives you some tools to determine when you’re making copies.</p>
</div>
<div id="t-test" class="section level2" number="24.7">
<h2>
<span class="header-section-number">24.7</span> Case study: t-test<a class="anchor" aria-label="anchor" href="#t-test"><i class="fas fa-link"></i></a>
</h2>
<p>The following case study shows how to make t-tests faster using some of the techniques described above. It’s based on an example in <a href="http://stat-computing.org/newsletter/issues/scgn-18-1.pdf"><em>Computing thousands of test statistics simultaneously in R</em></a> by Holger Schwender and Tina Müller. I thoroughly recommend reading the paper in full to see the same idea applied to other tests.</p>
<p>Imagine we have run 1000 experiments (rows), each of which collects data on 50 individuals (columns). The first 25 individuals in each experiment are assigned to group 1 and the rest to group 2. We’ll first generate some random data to represent this problem:</p>
<div class="sourceCode" id="cb995"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">50</span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">m</span> <span class="op">*</span> <span class="va">n</span>, mean <span class="op">=</span> <span class="fl">10</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">m</span><span class="op">)</span>
<span class="va">grp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, each <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p>For data in this form, there are two ways to use <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code>. We can either use the formula interface or provide two vectors, one for each group. Timing reveals that the formula interface is considerably slower.</p>
<div class="sourceCode" id="cb996"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">~</span> <span class="va">grp</span><span class="op">)</span><span class="op">$</span><span class="va">statistic</span>
  <span class="op">}</span>
<span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;    2.07    0.00    2.25</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">i</span>, <span class="va">grp</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">X</span><span class="op">[</span><span class="va">i</span>, <span class="va">grp</span> <span class="op">==</span> <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">statistic</span>
  <span class="op">}</span>
<span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;    0.41    0.00    0.43</span></code></pre></div>
<p>Of course, a for loop computes, but doesn’t save the values. We can <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> (Section <a href="functionals.html#map-atomic">9.2.1</a>) to do that. This adds a little overhead:</p>
<div class="sourceCode" id="cb997"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">compT</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">i</span>, <span class="va">grp</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="va">X</span><span class="op">[</span><span class="va">i</span>, <span class="va">grp</span> <span class="op">==</span> <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">statistic</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">m</span>, <span class="va">compT</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;    0.42    0.00    0.52</span></code></pre></div>
<p>How can we make this faster? First, we could try doing less work. If you look at the source code of <code>stats:::t.test.default()</code>, you’ll see that it does a lot more than just compute the t-statistic. It also computes the p-value and formats the output for printing. We can try to make our code faster by stripping out those pieces.</p>
<div class="sourceCode" id="cb998"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_t</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">grp</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">t_stat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
    <span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">m</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>

    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>m <span class="op">=</span> <span class="va">m</span>, n <span class="op">=</span> <span class="va">n</span>, var <span class="op">=</span> <span class="va">var</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu">t_stat</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">grp</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span>
  <span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu">t_stat</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">grp</span> <span class="op">==</span> <span class="fl">2</span><span class="op">]</span><span class="op">)</span>

  <span class="va">se_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">g1</span><span class="op">$</span><span class="va">var</span> <span class="op">/</span> <span class="va">g1</span><span class="op">$</span><span class="va">n</span> <span class="op">+</span> <span class="va">g2</span><span class="op">$</span><span class="va">var</span> <span class="op">/</span> <span class="va">g2</span><span class="op">$</span><span class="va">n</span><span class="op">)</span>
  <span class="op">(</span><span class="va">g1</span><span class="op">$</span><span class="va">m</span> <span class="op">-</span> <span class="va">g2</span><span class="op">$</span><span class="va">m</span><span class="op">)</span> <span class="op">/</span> <span class="va">se_total</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">t2</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">m</span>, <span class="op">~</span> <span class="fu">my_t</span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">.</span>,<span class="op">]</span>, <span class="va">grp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;    0.08    0.00    0.07</span>
<span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">t1</span>, <span class="va">t2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>This gives us about a six-fold speed improvement.</p>
<p>Now that we have a fairly simple function, we can make it faster still by vectorising it. Instead of looping over the array outside the function, we will modify <code>t_stat()</code> to work with a matrix of values. Thus, <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> becomes <code><a href="https://rdrr.io/r/base/colSums.html">rowMeans()</a></code>, <code><a href="https://rdrr.io/r/base/length.html">length()</a></code> becomes <code><a href="https://rdrr.io/r/base/nrow.html">ncol()</a></code>, and <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> becomes <code><a href="https://rdrr.io/r/base/colSums.html">rowSums()</a></code>. The rest of the code stays the same.</p>
<div class="sourceCode" id="cb999"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rowtstat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">grp</span><span class="op">)</span><span class="op">{</span>
  <span class="va">t_stat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>
    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>
    <span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="op">(</span><span class="va">X</span> <span class="op">-</span> <span class="va">m</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>

    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>m <span class="op">=</span> <span class="va">m</span>, n <span class="op">=</span> <span class="va">n</span>, var <span class="op">=</span> <span class="va">var</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu">t_stat</span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="va">grp</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span>
  <span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu">t_stat</span><span class="op">(</span><span class="va">X</span><span class="op">[</span>, <span class="va">grp</span> <span class="op">==</span> <span class="fl">2</span><span class="op">]</span><span class="op">)</span>

  <span class="va">se_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">g1</span><span class="op">$</span><span class="va">var</span> <span class="op">/</span> <span class="va">g1</span><span class="op">$</span><span class="va">n</span> <span class="op">+</span> <span class="va">g2</span><span class="op">$</span><span class="va">var</span> <span class="op">/</span> <span class="va">g2</span><span class="op">$</span><span class="va">n</span><span class="op">)</span>
  <span class="op">(</span><span class="va">g1</span><span class="op">$</span><span class="va">m</span> <span class="op">-</span> <span class="va">g2</span><span class="op">$</span><span class="va">m</span><span class="op">)</span> <span class="op">/</span> <span class="va">se_total</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">t3</span> <span class="op">&lt;-</span> <span class="fu">rowtstat</span><span class="op">(</span><span class="va">X</span>, <span class="va">grp</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;    0.03    0.00    0.03</span>
<span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">t1</span>, <span class="va">t3</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>That’s much faster! It’s at least 40 times faster than our previous effort, and around 1000 times faster than where we started.</p>
<!-- These timing comparisons are not reflected in the code. In the pdf copy this last function takes 0.011 s while the original version takes 0.191 s (about 17 times slower). Maybe there was improvement in the base version of t.test? -->
</div>
<div id="more-techniques" class="section level2" number="24.8">
<h2>
<span class="header-section-number">24.8</span> Other techniques<a class="anchor" aria-label="anchor" href="#more-techniques"><i class="fas fa-link"></i></a>
</h2>
<p>Being able to write fast R code is part of being a good R programmer. Beyond the specific hints in this chapter, if you want to write fast R code, you’ll need to improve your general programming skills. Some ways to do this are to:</p>
<ul>
<li><p><a href="http://www.r-bloggers.com/">Read R blogs</a> to see what performance
problems other people have struggled with, and how they have made their
code faster.</p></li>
<li><p>Read other R programming books, like <em>The Art of R Programming</em><span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Norman Matloff, &lt;em&gt;The Art of &lt;span&gt;R&lt;/span&gt; Programming&lt;/em&gt; (No Starch Press, 2011).&lt;/p&gt;"><sup>112</sup></a></span> or Patrick Burns’
<a href="http://www.burns-stat.com/documents/books/the-r-inferno/"><em>R Inferno</em></a> to
learn about common traps.</p></li>
<li><p>Take an algorithms and data structure course to learn some
well known ways of tackling certain classes of problems. I have heard
good things about Princeton’s
<a href="https://www.coursera.org/course/algs4partI">Algorithms course</a> offered on
Coursera.</p></li>
<li><p>Learn how to parallelise your code. Two places to start are
<em>Parallel R</em><span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Q. Ethan McCallum and Steve Weston, &lt;em&gt;Parallel &lt;span&gt;R&lt;/span&gt;&lt;/em&gt; (O’Reilly, 2011), &lt;a href="http://amzn.com/B005Z29QT4" role="doc-biblioref"&gt;http://amzn.com/B005Z29QT4&lt;/a&gt;.&lt;/p&gt;'><sup>113</sup></a></span> and <em>Parallel Computing for Data Science</em>.<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Norman Matloff, &lt;em&gt;Parallel Computing for Data Science&lt;/em&gt; (Chapman &amp;amp; Hall/CRC, 2015), &lt;a href="http://amzn.com/1466587016" role="doc-biblioref"&gt;http://amzn.com/1466587016&lt;/a&gt;.&lt;/p&gt;'><sup>114</sup></a></span></p></li>
<li><p>Read general books about optimisation like <em>Mature optimisation</em><span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Carlos Bueno, &lt;em&gt;Mature Optimization Handbook&lt;/em&gt;, 2013, &lt;a href="http://carlos.bueno.org/optimization/" role="doc-biblioref"&gt;http://carlos.bueno.org/optimization/&lt;/a&gt;.&lt;/p&gt;'><sup>115</sup></a></span>
or the <em>Pragmatic Programmer</em>.<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Hunt and Thomas, &lt;em&gt;The Pragmatic Programmer&lt;/em&gt;.&lt;/p&gt;"><sup>116</sup></a></span></p></li>
</ul>
<p>You can also reach out to the community for help. StackOverflow can be a useful resource. You’ll need to put some effort into creating an easily digestible example that also captures the salient features of your problem. If your example is too complex, few people will have the time and motivation to attempt a solution. If it’s too simple, you’ll get answers that solve the toy problem but not the real problem. If you also try to answer questions on StackOverflow, you’ll quickly get a feel for what makes a good question.</p>

</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="perf-measure.html"><span class="header-section-number">23</span> Measuring performance</a></div>
<div class="next"><a href="rcpp.html"><span class="header-section-number">25</span> Rewriting R code in C++</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#perf-improve"><span class="header-section-number">24</span> Improving performance</a></li>
<li>
<a class="nav-link" href="#introduction-23"><span class="header-section-number">24.1</span> Introduction</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#outline-22">Outline</a></li>
<li><a class="nav-link" href="#prerequisites-16">Prerequisites</a></li>
</ul>
</li>
<li><a class="nav-link" href="#code-organisation"><span class="header-section-number">24.2</span> Code organisation</a></li>
<li>
<a class="nav-link" href="#already-solved"><span class="header-section-number">24.3</span> Checking for existing solutions</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#exercises-70"><span class="header-section-number">24.3.1</span> Exercises</a></li></ul>
</li>
<li>
<a class="nav-link" href="#be-lazy"><span class="header-section-number">24.4</span> Doing as little as possible</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#mean"><span class="header-section-number">24.4.1</span> mean()</a></li>
<li><a class="nav-link" href="#as.data.frame"><span class="header-section-number">24.4.2</span> as.data.frame()</a></li>
<li><a class="nav-link" href="#exercises-71"><span class="header-section-number">24.4.3</span> Exercises</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#vectorise"><span class="header-section-number">24.5</span> Vectorise</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#exercises-72"><span class="header-section-number">24.5.1</span> Exercises</a></li></ul>
</li>
<li><a class="nav-link" href="#avoid-copies"><span class="header-section-number">24.6</span> Avoiding copies</a></li>
<li><a class="nav-link" href="#t-test"><span class="header-section-number">24.7</span> Case study: t-test</a></li>
<li><a class="nav-link" href="#more-techniques"><span class="header-section-number">24.8</span> Other techniques</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/hadley/adv-r/blob/master/Perf-improve.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/hadley/adv-r/edit/master/Perf-improve.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R avanzado</strong>" was written by Jeshua Romero Guadarrama. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
