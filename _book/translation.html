<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>21 Translating R code | R avanzado</title>
<meta name="author" content="Jeshua Romero Guadarrama">
<meta name="generator" content="bookdown 0.24.4 with bs4_book()">
<meta property="og:title" content="21 Translating R code | R avanzado">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="21 Translating R code | R avanzado">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1.9000/transition.js"></script><script src="libs/bs3compat-0.3.1.9000/tabs.js"></script><script src="libs/bs3compat-0.3.1.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141212623-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-141212623-1');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><meta name="description" content="21.1 Introduction The combination of first-class environments, lexical scoping, and metaprogramming gives us a powerful toolkit for translating R code into other languages. One fully-fledged...">
<meta property="og:description" content="21.1 Introduction The combination of first-class environments, lexical scoping, and metaprogramming gives us a powerful toolkit for translating R code into other languages. One fully-fledged...">
<meta name="twitter:description" content="21.1 Introduction The combination of first-class environments, lexical scoping, and metaprogramming gives us a powerful toolkit for translating R code into other languages. One fully-fledged...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R avanzado</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li class="book-part">Foundations</li>
<li><a class="" href="foundations-intro.html">Introduction</a></li>
<li><a class="" href="names-values.html"><span class="header-section-number">2</span> Names and values</a></li>
<li><a class="" href="vectors-chap.html"><span class="header-section-number">3</span> Vectors</a></li>
<li><a class="" href="subsetting.html"><span class="header-section-number">4</span> Subsetting</a></li>
<li><a class="" href="control-flow.html"><span class="header-section-number">5</span> Control flow</a></li>
<li><a class="" href="functions.html"><span class="header-section-number">6</span> Functions</a></li>
<li><a class="" href="environments.html"><span class="header-section-number">7</span> Environments</a></li>
<li><a class="" href="conditions.html"><span class="header-section-number">8</span> Conditions</a></li>
<li class="book-part">Functional programming</li>
<li><a class="" href="fp.html">Introduction</a></li>
<li><a class="" href="functionals.html"><span class="header-section-number">9</span> Functionals</a></li>
<li><a class="" href="function-factories.html"><span class="header-section-number">10</span> Function factories</a></li>
<li><a class="" href="function-operators.html"><span class="header-section-number">11</span> Function operators</a></li>
<li class="book-part">Object-oriented programming</li>
<li><a class="" href="oo.html">Introduction</a></li>
<li><a class="" href="base-types.html"><span class="header-section-number">12</span> Base types</a></li>
<li><a class="" href="s3.html"><span class="header-section-number">13</span> S3</a></li>
<li><a class="" href="r6.html"><span class="header-section-number">14</span> R6</a></li>
<li><a class="" href="s4.html"><span class="header-section-number">15</span> S4</a></li>
<li><a class="" href="oo-tradeoffs.html"><span class="header-section-number">16</span> Trade-offs</a></li>
<li class="book-part">Metaprogramming</li>
<li><a class="" href="metaprogramming.html">Introduction</a></li>
<li><a class="" href="meta-big-picture.html"><span class="header-section-number">17</span> Big picture</a></li>
<li><a class="" href="expressions.html"><span class="header-section-number">18</span> Expressions</a></li>
<li><a class="" href="quasiquotation.html"><span class="header-section-number">19</span> Quasiquotation</a></li>
<li><a class="" href="evaluation.html"><span class="header-section-number">20</span> Evaluation</a></li>
<li><a class="active" href="translation.html"><span class="header-section-number">21</span> Translating R code</a></li>
<li class="book-part">Techniques</li>
<li><a class="" href="techniques.html">Introduction</a></li>
<li><a class="" href="debugging.html"><span class="header-section-number">22</span> Debugging</a></li>
<li><a class="" href="perf-measure.html"><span class="header-section-number">23</span> Measuring performance</a></li>
<li><a class="" href="perf-improve.html"><span class="header-section-number">24</span> Improving performance</a></li>
<li><a class="" href="rcpp.html"><span class="header-section-number">25</span> Rewriting R code in C++</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/hadley/adv-r">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="translation" class="section level1" number="21">
<h1>
<span class="header-section-number">21</span> Translating R code<a class="anchor" aria-label="anchor" href="#translation"><i class="fas fa-link"></i></a>
</h1>
<div id="introduction-20" class="section level2" number="21.1">
<h2>
<span class="header-section-number">21.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-20"><i class="fas fa-link"></i></a>
</h2>
<p>The combination of first-class environments, lexical scoping, and metaprogramming gives us a powerful toolkit for translating R code into other languages. One fully-fledged example of this idea is dbplyr, which powers the database backends for dplyr, allowing you to express data manipulation in R and automatically translate it into SQL. You can see the key idea in <code><a href="https://dbplyr.tidyverse.org/reference/translate_sql.html">translate_sql()</a></code> which takes R code and returns the equivalent SQL:</p>
<div class="sourceCode" id="cb920"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/">dbplyr</a></span><span class="op">)</span>
<span class="fu"><a href="https://dbplyr.tidyverse.org/reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; POWER(`x`, 2.0)</span>
<span class="fu"><a href="https://dbplyr.tidyverse.org/reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&lt;</span> <span class="fl">5</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; `x` &lt; 5.0 AND NOT(((`x`) IS NULL))</span>
<span class="fu"><a href="https://dbplyr.tidyverse.org/reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="op">!</span><span class="va">first</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"John"</span>, <span class="st">"Roger"</span>, <span class="st">"Robert"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; NOT(`first` IN ('John', 'Roger', 'Robert'))</span>
<span class="fu"><a href="https://dbplyr.tidyverse.org/reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">select</span> <span class="op">==</span> <span class="fl">7</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; `select` = 7.0</span></code></pre></div>
<p>Translating R to SQL is complex because of the many idiosyncrasies of SQL dialects, so here I’ll develop two simple, but useful, domain specific languages (DSL): one to generate HTML, and the other to generate mathematical equations in LaTeX.</p>
<p>If you’re interested in learning more about domain specific languages in general, I highly recommend <em>Domain Specific Languages</em>.<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Martin Fowler, &lt;em&gt;Domain-Specific Languages&lt;/em&gt; (Pearson Education, 2010), &lt;a href="http://amzn.com/0321712943" role="doc-biblioref"&gt;http://amzn.com/0321712943&lt;/a&gt;.&lt;/p&gt;'><sup>106</sup></a></span> It discusses many options for creating a DSL and provides many examples of different languages.</p>
<div id="outline-19" class="section level3 unnumbered">
<h3>Outline<a class="anchor" aria-label="anchor" href="#outline-19"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>Section <a href="translation.html#html">21.2</a> creates a DSL for generating HTML, using quasiquotation
and purrr to generate a function for each HTML tag, then tidy evaluation to
easily access them.</p></li>
<li><p>Section <a href="translation.html#latex">21.3</a> transforms mathematically R code into its LaTeX
equivalent using a combination of tidy evaluation and expression walking.</p></li>
</ul>
</div>
<div id="prerequisites-14" class="section level3 unnumbered">
<h3>Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites-14"><i class="fas fa-link"></i></a>
</h3>
<p>This chapter pulls together many techniques discussed elsewhere in the book. In particular, you’ll need to understand environments, expressions, tidy evaluation, and a little functional programming and S3. We’ll use <a href="https://rlang.r-lib.org">rlang</a> for metaprogramming tools, and <a href="https://purrr.tidyverse.org">purrr</a> for functional programming.</p>
<div class="sourceCode" id="cb921"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rlang.r-lib.org">rlang</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="html" class="section level2" number="21.2">
<h2>
<span class="header-section-number">21.2</span> HTML<a class="anchor" aria-label="anchor" href="#html"><i class="fas fa-link"></i></a>
</h2>
<p></p>
<p>HTML (HyperText Markup Language) underlies the majority of the web. It’s a special case of SGML (Standard Generalised Markup Language), and it’s similar but not identical to XML (eXtensible Markup Language). HTML looks like this:</p>
<div class="sourceCode" id="cb922"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb922-1"><a href="translation.html#cb922-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb922-2"><a href="translation.html#cb922-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;h1</span> <span class="er">id</span><span class="ot">=</span><span class="st">'first'</span><span class="kw">&gt;</span>A heading<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb922-3"><a href="translation.html#cb922-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;p&gt;</span>Some text <span class="dv">&amp;amp;</span> <span class="kw">&lt;b&gt;</span>some bold text.<span class="kw">&lt;/b&gt;&lt;/p&gt;</span></span>
<span id="cb922-4"><a href="translation.html#cb922-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;img</span> <span class="er">src</span><span class="ot">=</span><span class="st">'myimg.png'</span> <span class="er">width</span><span class="ot">=</span><span class="st">'100'</span> <span class="er">height</span><span class="ot">=</span><span class="st">'100'</span> <span class="kw">/&gt;</span></span>
<span id="cb922-5"><a href="translation.html#cb922-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span></code></pre></div>
<p>Even if you’ve never looked at HTML before, you can still see that the key component of its coding structure is tags, which look like <code>&lt;tag&gt;&lt;/tag&gt;</code> or <code>&lt;tag /&gt;</code>. Tags can be nested within other tags and intermingled with text. There are over 100 HTML tags, but in this chapter we’ll focus on just a handful:</p>
<ul>
<li>
<code>&lt;body&gt;</code> is the top-level tag that contains all content.</li>
<li>
<code>&lt;h1&gt;</code> defines a top level heading.</li>
<li>
<code>&lt;p&gt;</code> defines a paragraph.</li>
<li>
<code>&lt;b&gt;</code> emboldens text.</li>
<li>
<code>&lt;img&gt;</code> embeds an image.</li>
</ul>
<p>Tags can have named <strong>attributes</strong> which look like <code>&lt;tag name1='value1' name2='value2'&gt;&lt;/tag&gt;</code>. Two of the most important attributes are <code>id</code> and <code>class</code>, which are used in conjunction with CSS (Cascading Style Sheets) to control the visual appearance of the page.</p>
<p><strong>Void tags</strong>, like <code>&lt;img&gt;</code>, don’t have any children, and are written <code>&lt;img /&gt;</code>, not <code>&lt;img&gt;&lt;/img&gt;</code>. Since they have no content, attributes are more important, and <code>img</code> has three that are used with almost every image: <code>src</code> (where the image lives), <code>width</code>, and <code>height</code>.</p>
<p>Because <code>&lt;</code> and <code>&gt;</code> have special meanings in HTML, you can’t write them directly. Instead you have to use the HTML <strong>escapes</strong>: <code>&amp;gt;</code> and <code>&amp;lt;</code>. And since those escapes use <code>&amp;</code>, if you want a literal ampersand you have to escape it as <code>&amp;amp;</code>.</p>
<div id="goal" class="section level3" number="21.2.1">
<h3>
<span class="header-section-number">21.2.1</span> Goal<a class="anchor" aria-label="anchor" href="#goal"><i class="fas fa-link"></i></a>
</h3>
<p>Our goal is to make it easy to generate HTML from R. To give a concrete example, we want to generate the following HTML:</p>
<div class="sourceCode" id="cb923"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb923-1"><a href="translation.html#cb923-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb923-2"><a href="translation.html#cb923-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;h1</span> <span class="er">id</span><span class="ot">=</span><span class="st">'first'</span><span class="kw">&gt;</span>A heading<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb923-3"><a href="translation.html#cb923-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;p&gt;</span>Some text <span class="dv">&amp;amp;</span> <span class="kw">&lt;b&gt;</span>some bold text.<span class="kw">&lt;/b&gt;&lt;/p&gt;</span></span>
<span id="cb923-4"><a href="translation.html#cb923-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;img</span> <span class="er">src</span><span class="ot">=</span><span class="st">'myimg.png'</span> <span class="er">width</span><span class="ot">=</span><span class="st">'100'</span> <span class="er">height</span><span class="ot">=</span><span class="st">'100'</span> <span class="kw">/&gt;</span></span>
<span id="cb923-5"><a href="translation.html#cb923-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span></code></pre></div>
<p>Using the following code that matches the structure of the HTML as closely as possible:</p>
<div class="sourceCode" id="cb924"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">with_html</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/body.html">body</a></span><span class="op">(</span>
    <span class="fu">h1</span><span class="op">(</span><span class="st">"A heading"</span>, id <span class="op">=</span> <span class="st">"first"</span><span class="op">)</span>,
    <span class="fu">p</span><span class="op">(</span><span class="st">"Some text &amp;"</span>, <span class="fu">b</span><span class="op">(</span><span class="st">"some bold text."</span><span class="op">)</span><span class="op">)</span>,
    <span class="fu">img</span><span class="op">(</span>src <span class="op">=</span> <span class="st">"myimg.png"</span>, width <span class="op">=</span> <span class="fl">100</span>, height <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>This DSL has the following three properties:</p>
<ul>
<li><p>The nesting of function calls matches the nesting of tags.</p></li>
<li><p>Unnamed arguments become the content of the tag, and named arguments
become their attributes.</p></li>
<li><p><code>&amp;</code> and other special characters are automatically escaped.</p></li>
</ul>
</div>
<div id="escaping" class="section level3" number="21.2.2">
<h3>
<span class="header-section-number">21.2.2</span> Escaping<a class="anchor" aria-label="anchor" href="#escaping"><i class="fas fa-link"></i></a>
</h3>
<p></p>
<p>Escaping is so fundamental to translation that it’ll be our first topic. There are two related challenges:</p>
<ul>
<li><p>In user input, we need to automatically escape <code>&amp;</code>, <code>&lt;</code> and <code>&gt;</code>.</p></li>
<li><p>At the same time we need to make sure that the <code>&amp;</code>, <code>&lt;</code> and <code>&gt;</code> we generate
are not double-escaped (i.e. that we don’t accidentally generate <code>&amp;amp;amp;</code>, <code>&amp;amp;lt;</code> and <code>&amp;amp;gt;</code>).</p></li>
</ul>
<p>The easiest way to do this is to create an S3 class (Section <a href="s3.html#s3-classes">13.3</a>) that distinguishes between regular text (that needs escaping) and HTML (that doesn’t).</p>
<div class="sourceCode" id="cb925"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">html</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="va">x</span>, class <span class="op">=</span> <span class="st">"advr_html"</span><span class="op">)</span>

<span class="va">print.advr_html</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"&lt;HTML&gt; "</span>, <span class="va">x</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strwrap.html">strwrap</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span>, <span class="st">"\n"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We then write an escape generic. It has two important methods:</p>
<ul>
<li><p><code>escape.character()</code> takes a regular character vector and returns an HTML
vector with special characters (<code>&amp;</code>, <code>&lt;</code>, <code>&gt;</code>) escaped.</p></li>
<li><p><code>escape.advr_html()</code> leaves already escaped HTML alone.</p></li>
</ul>
<div class="sourceCode" id="cb926"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">escape</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html">UseMethod</a></span><span class="op">(</span><span class="st">"escape"</span><span class="op">)</span>

<span class="va">escape.character</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"&amp;"</span>, <span class="st">"&amp;amp;"</span>, <span class="va">x</span><span class="op">)</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"&lt;"</span>, <span class="st">"&amp;lt;"</span>, <span class="va">x</span><span class="op">)</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"&gt;"</span>, <span class="st">"&amp;gt;"</span>, <span class="va">x</span><span class="op">)</span>

  <span class="fu">html</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">escape.advr_html</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span></code></pre></div>
<p>Now we check that it works</p>
<div class="sourceCode" id="cb927"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dbplyr.tidyverse.org/reference/escape.html">escape</a></span><span class="op">(</span><span class="st">"This is some text."</span><span class="op">)</span>
<span class="co">#&gt; &lt;HTML&gt; This is some text.</span>
<span class="fu"><a href="https://dbplyr.tidyverse.org/reference/escape.html">escape</a></span><span class="op">(</span><span class="st">"x &gt; 1 &amp; y &lt; 2"</span><span class="op">)</span>
<span class="co">#&gt; &lt;HTML&gt; x &amp;gt; 1 &amp;amp; y &amp;lt; 2</span>

<span class="co"># Double escaping is not a problem</span>
<span class="fu"><a href="https://dbplyr.tidyverse.org/reference/escape.html">escape</a></span><span class="op">(</span><span class="fu"><a href="https://dbplyr.tidyverse.org/reference/escape.html">escape</a></span><span class="op">(</span><span class="st">"This is some text. 1 &gt; 2"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;HTML&gt; This is some text. 1 &amp;gt; 2</span>

<span class="co"># And text we know is HTML doesn't get escaped.</span>
<span class="fu"><a href="https://dbplyr.tidyverse.org/reference/escape.html">escape</a></span><span class="op">(</span><span class="fu">html</span><span class="op">(</span><span class="st">"&lt;hr /&gt;"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;HTML&gt; &lt;hr /&gt;</span></code></pre></div>
<p>Conveniently, this also allows a user to opt out of our escaping if they know the content is already escaped.</p>
</div>
<div id="basic-tag-functions" class="section level3" number="21.2.3">
<h3>
<span class="header-section-number">21.2.3</span> Basic tag functions<a class="anchor" aria-label="anchor" href="#basic-tag-functions"><i class="fas fa-link"></i></a>
</h3>
<p>Next, we’ll write a one-tag function by hand, then figure out how to generalise it so we can generate a function for every tag with code.</p>
<p>Let’s start with <code>&lt;p&gt;</code>. HTML tags can have both attributes (e.g., id or class) and children (like <code>&lt;b&gt;</code> or <code>&lt;i&gt;</code>). We need some way of separating these in the function call. Given that attributes are named and children are not, it seems natural to use named and unnamed arguments for them respectively. For example, a call to <code>p()</code> might look like:</p>
<div class="sourceCode" id="cb928"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">p</span><span class="op">(</span><span class="st">"Some text. "</span>, <span class="fu">b</span><span class="op">(</span><span class="fu">i</span><span class="op">(</span><span class="st">"some bold italic text"</span><span class="op">)</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"mypara"</span><span class="op">)</span></code></pre></div>
<p>We could list all the possible attributes of the <code>&lt;p&gt;</code> tag in the function definition, but that’s hard because there are many attributes, and because it’s possible to use <a href="http://html5doctor.com/html5-custom-data-attributes/">custom attributes</a>. Instead, we’ll use <code>...</code> and separate the components based on whether or not they are named. With this in mind, we create a helper function that wraps around <code><a href="https://rlang.r-lib.org/reference/list2.html">rlang::list2()</a></code> (Section <a href="quasiquotation.html#tidy-dots">19.6</a>) and returns named and unnamed components separately:</p>
<div class="sourceCode" id="cb929"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dots_partition</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">dots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/list2.html">list2</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
  
 <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dots</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">is_named</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">dots</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="va">is_named</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dots</span><span class="op">)</span> <span class="op">!=</span> <span class="st">""</span>
<span class="op">}</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    named <span class="op">=</span> <span class="va">dots</span><span class="op">[</span><span class="va">is_named</span><span class="op">]</span>,
    unnamed <span class="op">=</span> <span class="va">dots</span><span class="op">[</span><span class="op">!</span><span class="va">is_named</span><span class="op">]</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="fu">dots_partition</span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span>, <span class="fl">2</span>, b <span class="op">=</span> <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; List of 2</span>
<span class="co">#&gt;  $ named  :List of 2</span>
<span class="co">#&gt;   ..$ a: num 1</span>
<span class="co">#&gt;   ..$ b: num 3</span>
<span class="co">#&gt;  $ unnamed:List of 2</span>
<span class="co">#&gt;   ..$ : num 2</span>
<span class="co">#&gt;   ..$ : num 4</span></code></pre></div>
<p>We can now create our <code>p()</code> function. Notice that there’s one new function here: <code>html_attributes()</code>. It takes a named list and returns the HTML attribute specification as a string. It’s a little complicated (in part, because it deals with some idiosyncrasies of HTML that I haven’t mentioned here), but it’s not that important and doesn’t introduce any new programming ideas, so I won’t discuss it in detail. You can find the <a href="https://github.com/hadley/adv-r/blob/master/dsl-html-attributes.r">source online</a> if you want to work through it yourself.</p>
<!-- GVW: possible/useful to show a very simple version of `html_attributes`, then point out one or two cases for which it fails, then tell them to read the source? I'm always nervous when someone tells me "you don't need to worry about the details of this" -->
<div class="sourceCode" id="cb930"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"dsl-html-attributes.r"</span><span class="op">)</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">dots</span> <span class="op">&lt;-</span> <span class="fu">dots_partition</span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
  <span class="va">attribs</span> <span class="op">&lt;-</span> <span class="fu">html_attributes</span><span class="op">(</span><span class="va">dots</span><span class="op">$</span><span class="va">named</span><span class="op">)</span>
  <span class="va">children</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_chr</a></span><span class="op">(</span><span class="va">dots</span><span class="op">$</span><span class="va">unnamed</span>, <span class="va">escape</span><span class="op">)</span>

  <span class="fu">html</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"&lt;p"</span>, <span class="va">attribs</span>, <span class="st">"&gt;"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">children</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,
    <span class="st">"&lt;/p&gt;"</span>
  <span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">p</span><span class="op">(</span><span class="st">"Some text"</span><span class="op">)</span>
<span class="co">#&gt; &lt;HTML&gt; &lt;p&gt;Some text&lt;/p&gt;</span>
<span class="fu">p</span><span class="op">(</span><span class="st">"Some text"</span>, id <span class="op">=</span> <span class="st">"myid"</span><span class="op">)</span>
<span class="co">#&gt; &lt;HTML&gt; &lt;p id='myid'&gt;Some text&lt;/p&gt;</span>
<span class="fu">p</span><span class="op">(</span><span class="st">"Some text"</span>, class <span class="op">=</span> <span class="st">"important"</span>, `data-value` <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt; &lt;HTML&gt; &lt;p class='important' data-value='10'&gt;Some text&lt;/p&gt;</span></code></pre></div>
</div>
<div id="tag-functions" class="section level3" number="21.2.4">
<h3>
<span class="header-section-number">21.2.4</span> Tag functions<a class="anchor" aria-label="anchor" href="#tag-functions"><i class="fas fa-link"></i></a>
</h3>
<p>It’s straightforward to adapt <code>p()</code> to other tags: we just need to replace <code>"p"</code> with the name of the tag. One elegant way to do that is to create a function with <code><a href="https://rlang.r-lib.org/reference/new_function.html">rlang::new_function()</a></code> (Section <a href="quasiquotation.html#new-function">19.7.4</a>), using unquoting and <code><a href="https://rdrr.io/r/base/paste.html">paste0()</a></code> to generate the starting and ending tags.</p>
<div class="sourceCode" id="cb931"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tag</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tag</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rlang.r-lib.org/reference/new_function.html">new_function</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">exprs</a></span><span class="op">(</span>... <span class="op">=</span> <span class="op">)</span>,
    <span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span><span class="op">(</span><span class="op">{</span>
      <span class="va">dots</span> <span class="op">&lt;-</span> <span class="fu">dots_partition</span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
      <span class="va">attribs</span> <span class="op">&lt;-</span> <span class="fu">html_attributes</span><span class="op">(</span><span class="va">dots</span><span class="op">$</span><span class="va">named</span><span class="op">)</span>
      <span class="va">children</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_chr</a></span><span class="op">(</span><span class="va">dots</span><span class="op">$</span><span class="va">unnamed</span>, <span class="va">escape</span><span class="op">)</span>

      <span class="fu">html</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
        <span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"&lt;"</span>, <span class="va">tag</span><span class="op">)</span>, <span class="va">attribs</span>, <span class="st">"&gt;"</span>,
        <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">children</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span>,
        <span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"&lt;/"</span>, <span class="va">tag</span>, <span class="st">"&gt;"</span><span class="op">)</span>
      <span class="op">)</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>,
    <span class="fu"><a href="https://rlang.r-lib.org/reference/caller_env.html">caller_env</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>
<span class="fu">tag</span><span class="op">(</span><span class="st">"b"</span><span class="op">)</span>
<span class="co">#&gt; function (...) </span>
<span class="co">#&gt; {</span>
<span class="co">#&gt;     dots &lt;- dots_partition(...)</span>
<span class="co">#&gt;     attribs &lt;- html_attributes(dots$named)</span>
<span class="co">#&gt;     children &lt;- map_chr(dots$unnamed, escape)</span>
<span class="co">#&gt;     html(paste0("&lt;b", attribs, "&gt;", paste(children, collapse = ""), </span>
<span class="co">#&gt;         "&lt;/b&gt;"))</span>
<span class="co">#&gt; }</span></code></pre></div>
<p>We need the weird <code>exprs(... = )</code> syntax to generate the empty <code>...</code> argument in the tag function. See Section <a href="expressions.html#empty-symbol">18.6.2</a> for more details.</p>
<p>Now we can run our earlier example:</p>
<div class="sourceCode" id="cb932"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">tag</span><span class="op">(</span><span class="st">"p"</span><span class="op">)</span>
<span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">tag</span><span class="op">(</span><span class="st">"b"</span><span class="op">)</span>
<span class="va">i</span> <span class="op">&lt;-</span> <span class="fu">tag</span><span class="op">(</span><span class="st">"i"</span><span class="op">)</span>
<span class="fu">p</span><span class="op">(</span><span class="st">"Some text. "</span>, <span class="fu">b</span><span class="op">(</span><span class="fu">i</span><span class="op">(</span><span class="st">"some bold italic text"</span><span class="op">)</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"mypara"</span><span class="op">)</span>
<span class="co">#&gt; &lt;HTML&gt; &lt;p class='mypara'&gt;Some text. &lt;b&gt;&lt;i&gt;some bold italic</span>
<span class="co">#&gt; text&lt;/i&gt;&lt;/b&gt;&lt;/p&gt;</span></code></pre></div>
<p>Before we generate functions for every possible HTML tag, we need to create a variant that handles void tags. <code>void_tag()</code> is quite similar to <code>tag()</code>, but it throws an error if there are any unnamed tags, and the tag itself looks a little different.</p>
<div class="sourceCode" id="cb933"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">void_tag</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tag</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rlang.r-lib.org/reference/new_function.html">new_function</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">exprs</a></span><span class="op">(</span>... <span class="op">=</span> <span class="op">)</span>,
    <span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span><span class="op">(</span><span class="op">{</span>
      <span class="va">dots</span> <span class="op">&lt;-</span> <span class="fu">dots_partition</span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">dots</span><span class="op">$</span><span class="va">unnamed</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
        <span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html">abort</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"&lt;"</span>, <span class="va">tag</span>, <span class="st">"&gt; must not have unnamed arguments"</span><span class="op">)</span><span class="op">)</span>
      <span class="op">}</span>
      <span class="va">attribs</span> <span class="op">&lt;-</span> <span class="fu">html_attributes</span><span class="op">(</span><span class="va">dots</span><span class="op">$</span><span class="va">named</span><span class="op">)</span>

      <span class="fu">html</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"&lt;"</span>, <span class="va">tag</span><span class="op">)</span>, <span class="va">attribs</span>, <span class="st">" /&gt;"</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>,
    <span class="fu"><a href="https://rlang.r-lib.org/reference/caller_env.html">caller_env</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="va">img</span> <span class="op">&lt;-</span> <span class="fu">void_tag</span><span class="op">(</span><span class="st">"img"</span><span class="op">)</span>
<span class="va">img</span>
<span class="co">#&gt; function (...) </span>
<span class="co">#&gt; {</span>
<span class="co">#&gt;     dots &lt;- dots_partition(...)</span>
<span class="co">#&gt;     if (length(dots$unnamed) &gt; 0) {</span>
<span class="co">#&gt;         abort("&lt;img&gt; must not have unnamed arguments")</span>
<span class="co">#&gt;     }</span>
<span class="co">#&gt;     attribs &lt;- html_attributes(dots$named)</span>
<span class="co">#&gt;     html(paste0("&lt;img", attribs, " /&gt;"))</span>
<span class="co">#&gt; }</span>
<span class="fu">img</span><span class="op">(</span>src <span class="op">=</span> <span class="st">"myimage.png"</span>, width <span class="op">=</span> <span class="fl">100</span>, height <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="co">#&gt; &lt;HTML&gt; &lt;img src='myimage.png' width='100' height='100' /&gt;</span></code></pre></div>
</div>
<div id="html-env" class="section level3" number="21.2.5">
<h3>
<span class="header-section-number">21.2.5</span> Processing all tags<a class="anchor" aria-label="anchor" href="#html-env"><i class="fas fa-link"></i></a>
</h3>
<p>Next we need to generate these functions for every tag. We’ll start with a list of all HTML tags:</p>
<div class="sourceCode" id="cb934"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"abbr"</span>, <span class="st">"address"</span>, <span class="st">"article"</span>, <span class="st">"aside"</span>, <span class="st">"audio"</span>,
  <span class="st">"b"</span>,<span class="st">"bdi"</span>, <span class="st">"bdo"</span>, <span class="st">"blockquote"</span>, <span class="st">"body"</span>, <span class="st">"button"</span>, <span class="st">"canvas"</span>,
  <span class="st">"caption"</span>,<span class="st">"cite"</span>, <span class="st">"code"</span>, <span class="st">"colgroup"</span>, <span class="st">"data"</span>, <span class="st">"datalist"</span>,
  <span class="st">"dd"</span>, <span class="st">"del"</span>,<span class="st">"details"</span>, <span class="st">"dfn"</span>, <span class="st">"div"</span>, <span class="st">"dl"</span>, <span class="st">"dt"</span>, <span class="st">"em"</span>,
  <span class="st">"eventsource"</span>,<span class="st">"fieldset"</span>, <span class="st">"figcaption"</span>, <span class="st">"figure"</span>, <span class="st">"footer"</span>,
  <span class="st">"form"</span>, <span class="st">"h1"</span>, <span class="st">"h2"</span>, <span class="st">"h3"</span>, <span class="st">"h4"</span>, <span class="st">"h5"</span>, <span class="st">"h6"</span>, <span class="st">"head"</span>, <span class="st">"header"</span>,
  <span class="st">"hgroup"</span>, <span class="st">"html"</span>, <span class="st">"i"</span>,<span class="st">"iframe"</span>, <span class="st">"ins"</span>, <span class="st">"kbd"</span>, <span class="st">"label"</span>,
  <span class="st">"legend"</span>, <span class="st">"li"</span>, <span class="st">"mark"</span>, <span class="st">"map"</span>,<span class="st">"menu"</span>, <span class="st">"meter"</span>, <span class="st">"nav"</span>,
  <span class="st">"noscript"</span>, <span class="st">"object"</span>, <span class="st">"ol"</span>, <span class="st">"optgroup"</span>, <span class="st">"option"</span>, <span class="st">"output"</span>,
  <span class="st">"p"</span>, <span class="st">"pre"</span>, <span class="st">"progress"</span>, <span class="st">"q"</span>, <span class="st">"ruby"</span>, <span class="st">"rp"</span>,<span class="st">"rt"</span>, <span class="st">"s"</span>, <span class="st">"samp"</span>,
  <span class="st">"script"</span>, <span class="st">"section"</span>, <span class="st">"select"</span>, <span class="st">"small"</span>, <span class="st">"span"</span>, <span class="st">"strong"</span>,
  <span class="st">"style"</span>, <span class="st">"sub"</span>, <span class="st">"summary"</span>, <span class="st">"sup"</span>, <span class="st">"table"</span>, <span class="st">"tbody"</span>, <span class="st">"td"</span>,
  <span class="st">"textarea"</span>, <span class="st">"tfoot"</span>, <span class="st">"th"</span>, <span class="st">"thead"</span>, <span class="st">"time"</span>, <span class="st">"title"</span>, <span class="st">"tr"</span>,
  <span class="st">"u"</span>, <span class="st">"ul"</span>, <span class="st">"var"</span>, <span class="st">"video"</span>
<span class="op">)</span>

<span class="va">void_tags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"area"</span>, <span class="st">"base"</span>, <span class="st">"br"</span>, <span class="st">"col"</span>, <span class="st">"command"</span>, <span class="st">"embed"</span>,
  <span class="st">"hr"</span>, <span class="st">"img"</span>, <span class="st">"input"</span>, <span class="st">"keygen"</span>, <span class="st">"link"</span>, <span class="st">"meta"</span>, <span class="st">"param"</span>,
  <span class="st">"source"</span>, <span class="st">"track"</span>, <span class="st">"wbr"</span>
<span class="op">)</span></code></pre></div>
<p>If you look at this list carefully, you’ll see there are quite a few tags that have the same name as base R functions (<code>body</code>, <code>col</code>, <code>q</code>, <code>source</code>, <code>sub</code>, <code>summary</code>, <code>table</code>). This means we don’t want to make all the functions available by default, either in the global environment or in a package. Instead, we’ll put them in a list (like in Section <a href="function-factories.html#functional-factories">10.5</a>) and then provide a helper to make it easy to use them when desired. First, we make a named list containing all the tag functions:</p>
<div class="sourceCode" id="cb935"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">html_tags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="va">tags</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">tag</span><span class="op">)</span>,
  <span class="va">void_tags</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">void_tag</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>This gives us an explicit (but verbose) way to create HTML:</p>
<div class="sourceCode" id="cb936"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">html_tags</span><span class="op">$</span><span class="fu">p</span><span class="op">(</span>
  <span class="st">"Some text. "</span>,
  <span class="va">html_tags</span><span class="op">$</span><span class="fu">b</span><span class="op">(</span><span class="va">html_tags</span><span class="op">$</span><span class="fu">i</span><span class="op">(</span><span class="st">"some bold italic text"</span><span class="op">)</span><span class="op">)</span>,
  class <span class="op">=</span> <span class="st">"mypara"</span>
<span class="op">)</span>
<span class="co">#&gt; &lt;HTML&gt; &lt;p class='mypara'&gt;Some text. &lt;b&gt;&lt;i&gt;some bold italic</span>
<span class="co">#&gt; text&lt;/i&gt;&lt;/b&gt;&lt;/p&gt;</span></code></pre></div>
<p>We can then finish off our HTML DSL with a function that allows us to evaluate code in the context of that list. Here we slightly abuse the data mask, passing it a list of functions rather than a data frame. This is quick hack to mingle the execution environment of <code>code</code> with the functions in <code>html_tags</code>.</p>
<div class="sourceCode" id="cb937"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">with_html</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">code</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">code</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">enquo</a></span><span class="op">(</span><span class="va">code</span><span class="op">)</span>
  <span class="fu"><a href="https://rlang.r-lib.org/reference/eval_tidy.html">eval_tidy</a></span><span class="op">(</span><span class="va">code</span>, <span class="va">html_tags</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>This gives us a succinct API which allows us to write HTML when we need it but doesn’t clutter up the namespace when we don’t.</p>
<div class="sourceCode" id="cb938"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">with_html</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/body.html">body</a></span><span class="op">(</span>
    <span class="fu">h1</span><span class="op">(</span><span class="st">"A heading"</span>, id <span class="op">=</span> <span class="st">"first"</span><span class="op">)</span>,
    <span class="fu">p</span><span class="op">(</span><span class="st">"Some text &amp;"</span>, <span class="fu">b</span><span class="op">(</span><span class="st">"some bold text."</span><span class="op">)</span><span class="op">)</span>,
    <span class="fu">img</span><span class="op">(</span>src <span class="op">=</span> <span class="st">"myimg.png"</span>, width <span class="op">=</span> <span class="fl">100</span>, height <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; &lt;HTML&gt; &lt;body&gt;&lt;h1 id='first'&gt;A heading&lt;/h1&gt;&lt;p&gt;Some text &amp;amp;&lt;b&gt;some</span>
<span class="co">#&gt; bold text.&lt;/b&gt;&lt;/p&gt;&lt;img src='myimg.png' width='100' height='100'</span>
<span class="co">#&gt; /&gt;&lt;/body&gt;</span></code></pre></div>
<p>If you want to access the R function overridden by an HTML tag with the same name inside <code>with_html()</code>, you can use the full <code>package::function</code> specification.</p>
</div>
<div id="exercises-66" class="section level3" number="21.2.6">
<h3>
<span class="header-section-number">21.2.6</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-66"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<p>The escaping rules for <code>&lt;script&gt;</code> tags are different because they contain
JavaScript, not HTML. Instead of escaping angle brackets or ampersands,
you need to escape <code>&lt;/script&gt;</code> so that the tag isn’t closed too early.
For example, <code>script("'&lt;/script&gt;'")</code>, shouldn’t generate this:</p>
<div class="sourceCode" id="cb939"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb939-1"><a href="translation.html#cb939-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;script&gt;</span><span class="st">'&lt;/script&gt;'</span><span class="kw">&lt;/script&gt;</span></span></code></pre></div>
<p>But</p>
<div class="sourceCode" id="cb940"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb940-1"><a href="translation.html#cb940-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;script&gt;</span><span class="st">'&lt;</span><span class="sc">\/</span><span class="st">script&gt;'</span><span class="kw">&lt;/script&gt;</span></span></code></pre></div>
<p>Adapt the <code><a href="https://dbplyr.tidyverse.org/reference/escape.html">escape()</a></code> to follow these rules when a new argument <code>script</code>
is set to <code>TRUE</code>.</p>
</li>
<li>
<p>The use of <code>...</code> for all functions has some big downsides. There’s no
input validation and there will be little information in the
documentation or autocomplete about how they are used in the function.
Create a new function that, when given a named list of tags and their
attribute names (like below), creates tag functions with named arguments.</p>
<div class="sourceCode" id="cb941"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"href"</span><span class="op">)</span>,
  img <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"src"</span>, <span class="st">"width"</span>, <span class="st">"height"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>All tags should get <code>class</code> and <code>id</code> attributes.</p>
</li>
<li>
<p>Reason about the following code that calls <code>with_html()</code> referencing objects
from the environment. Will it work or fail? Why? Run the code to
verify your predictions.</p>
<div class="sourceCode" id="cb942"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">greeting</span> <span class="op">&lt;-</span> <span class="st">"Hello!"</span>
<span class="fu">with_html</span><span class="op">(</span><span class="fu">p</span><span class="op">(</span><span class="va">greeting</span><span class="op">)</span><span class="op">)</span>

<span class="va">p</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="st">"p"</span>
<span class="va">address</span> <span class="op">&lt;-</span> <span class="st">"123 anywhere street"</span>
<span class="fu">with_html</span><span class="op">(</span><span class="fu">p</span><span class="op">(</span><span class="va">address</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</li>
<li><p>Currently the HTML doesn’t look terribly pretty, and it’s hard to see the
structure. How could you adapt <code>tag()</code> to do indenting and formatting?
(You may need to do some research into block and inline tags.)</p></li>
</ol>
</div>
</div>
<div id="latex" class="section level2" number="21.3">
<h2>
<span class="header-section-number">21.3</span> LaTeX<a class="anchor" aria-label="anchor" href="#latex"><i class="fas fa-link"></i></a>
</h2>
<p></p>
<p>The next DSL will convert R expressions into their LaTeX math equivalents. (This is a bit like <code><a href="https://rdrr.io/r/grDevices/plotmath.html">?plotmath</a></code>, but for text instead of plots.) LaTeX is the lingua franca of mathematicians and statisticians: it’s common to use LaTeX notation whenever you want to express an equation in text, like in email. Since many reports are produced using both R and LaTeX, it might be useful to be able to automatically convert mathematical expressions from one language to the other.</p>
<p>Because we need to convert both functions and names, this mathematical DSL will be more complicated than the HTML DSL. We’ll also need to create a default conversion, so that symbols that we don’t know about get a standard conversion. This means that we can no longer use just evaluation: we also need to walk the abstract syntax tree (AST).</p>
<div id="latex-mathematics" class="section level3" number="21.3.1">
<h3>
<span class="header-section-number">21.3.1</span> LaTeX mathematics<a class="anchor" aria-label="anchor" href="#latex-mathematics"><i class="fas fa-link"></i></a>
</h3>
<p>Before we begin, let’s quickly cover how formulas are expressed in LaTeX. The full standard is very complex, but fortunately is <a href="http://en.wikibooks.org/wiki/LaTeX/Mathematics">well documented</a>, and the most common commands have a fairly simple structure:</p>
<ul>
<li><p>Most simple mathematical equations are written in the same way you’d type
them in R: <code>x * y</code>, <code>z ^ 5</code>. Subscripts are written using <code>_</code> (e.g., <code>x_1</code>).</p></li>
<li><p>Special characters start with a <code>\</code>: <code>\pi</code> = <span class="math inline">\(\pi\)</span>, <code>\pm</code> = <span class="math inline">\(\pm\)</span>, and so on.
There are a huge number of symbols available in LaTeX: searching online for
<code>latex math symbols</code> returns many
<a href="http://www.sunilpatel.co.uk/latex-type/latex-math-symbols/">lists</a>.
There’s even <a href="http://detexify.kirelabs.org/classify.html">a service</a> that
will look up the symbol you sketch in the browser.</p></li>
<li><p>More complicated functions look like <code>\name{arg1}{arg2}</code>. For example, to
write a fraction you’d use <code>\frac{a}{b}</code>. To write a square root, you’d use
<code>\sqrt{a}</code>.</p></li>
<li><p>To group elements together use <code><a href="https://rdrr.io/r/base/Paren.html">{}</a></code>: i.e., <code>x ^ a + b</code> versus <code>x ^ {a + b}</code>.</p></li>
<li><p>In good math typesetting, a distinction is made between variables and
functions. But without extra information, LaTeX doesn’t know whether
<code>f(a * b)</code> represents calling the function <code>f</code> with input <code>a * b</code>,
or is shorthand for <code>f * (a * b)</code>. If <code>f</code> is a function, you can tell
LaTeX to typeset it using an upright font with <code>\textrm{f}(a * b)</code>.
(The <code>rm</code> stands for “Roman,” the opposite of italics.)</p></li>
</ul>
</div>
<div id="goal-1" class="section level3" number="21.3.2">
<h3>
<span class="header-section-number">21.3.2</span> Goal<a class="anchor" aria-label="anchor" href="#goal-1"><i class="fas fa-link"></i></a>
</h3>
<p>Our goal is to use these rules to automatically convert an R expression to its appropriate LaTeX representation. We’ll tackle this in four stages:</p>
<ul>
<li><p>Convert known symbols: <code>pi</code> → <code>\pi</code></p></li>
<li><p>Leave other symbols unchanged: <code>x</code> → <code>x</code>, <code>y</code> → <code>y</code></p></li>
<li><p>Convert known functions to their special forms: <code>sqrt(frac(a, b))</code> →
<code>\sqrt{\frac{a}{b}}</code></p></li>
<li><p>Wrap unknown functions with <code>\textrm</code>: <code>f(a)</code> → <code>\textrm{f}(a)</code></p></li>
</ul>
<p>We’ll code this translation in the opposite direction of what we did with the HTML DSL. We’ll start with infrastructure, because that makes it easy to experiment with our DSL, and then work our way back down to generate the desired output.</p>
</div>
<div id="to_math" class="section level3" number="21.3.3">
<h3>
<span class="header-section-number">21.3.3</span> <code>to_math</code>()<a class="anchor" aria-label="anchor" href="#to_math"><i class="fas fa-link"></i></a>
</h3>
<p>To begin, we need a wrapper function that will convert R expressions into LaTeX math expressions. This will work like <code>to_html()</code> by capturing the unevaluated expression and evaluating it in a special environment. There are two main differences:</p>
<ul>
<li><p>The evaluation environment is no longer constant, as it has to vary depending on
the input. This is necessary to handle unknown symbols and functions.</p></li>
<li><p>We never evaluate in the argument environment because we’re translating every
function to a LaTeX expression. The user will need to use explicitly <code>!!</code> in
order to evaluate normally.</p></li>
</ul>
<p>This gives us:</p>
<div class="sourceCode" id="cb943"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">to_math</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">expr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">enexpr</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/eval_bare.html">eval_bare</a></span><span class="op">(</span><span class="va">expr</span>, <span class="fu">latex_env</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span><span class="op">)</span>

  <span class="fu">latex</span><span class="op">(</span><span class="va">out</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">latex</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span><span class="va">x</span>, class <span class="op">=</span> <span class="st">"advr_latex"</span><span class="op">)</span>
<span class="va">print.advr_latex</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"&lt;LATEX&gt; "</span>, <span class="va">x</span>, <span class="st">"\n"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Next we’ll build up <code>latex_env()</code>, starting simply and getting progressively more complex.</p>
</div>
<div id="known-symbols" class="section level3" number="21.3.4">
<h3>
<span class="header-section-number">21.3.4</span> Known symbols<a class="anchor" aria-label="anchor" href="#known-symbols"><i class="fas fa-link"></i></a>
</h3>
<p>Our first step is to create an environment that will convert the special LaTeX symbols used for Greek characters, e.g., <code>pi</code> to <code>\pi</code>. We’ll use the trick from Section <a href="evaluation.html#subset">20.4.3</a> to bind the symbol <code>pi</code> to the value <code>"\pi"</code>.</p>
<div class="sourceCode" id="cb944"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">greek</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="st">"alpha"</span>, <span class="st">"theta"</span>, <span class="st">"tau"</span>, <span class="st">"beta"</span>, <span class="st">"vartheta"</span>, <span class="st">"pi"</span>, <span class="st">"upsilon"</span>,
  <span class="st">"gamma"</span>, <span class="st">"varpi"</span>, <span class="st">"phi"</span>, <span class="st">"delta"</span>, <span class="st">"kappa"</span>, <span class="st">"rho"</span>,
  <span class="st">"varphi"</span>, <span class="st">"epsilon"</span>, <span class="st">"lambda"</span>, <span class="st">"varrho"</span>, <span class="st">"chi"</span>, <span class="st">"varepsilon"</span>,
  <span class="st">"mu"</span>, <span class="st">"sigma"</span>, <span class="st">"psi"</span>, <span class="st">"zeta"</span>, <span class="st">"nu"</span>, <span class="st">"varsigma"</span>, <span class="st">"omega"</span>, <span class="st">"eta"</span>,
  <span class="st">"xi"</span>, <span class="st">"Gamma"</span>, <span class="st">"Lambda"</span>, <span class="st">"Sigma"</span>, <span class="st">"Psi"</span>, <span class="st">"Delta"</span>, <span class="st">"Xi"</span>,
  <span class="st">"Upsilon"</span>, <span class="st">"Omega"</span>, <span class="st">"Theta"</span>, <span class="st">"Pi"</span>, <span class="st">"Phi"</span>
<span class="op">)</span>
<span class="va">greek_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"\\"</span>, <span class="va">greek</span><span class="op">)</span>, <span class="va">greek</span><span class="op">)</span>
<span class="va">greek_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_environment.html">as_environment</a></span><span class="op">(</span><span class="va">greek_list</span><span class="op">)</span></code></pre></div>
<p>We can then check it:</p>
<div class="sourceCode" id="cb945"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">latex_env</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">greek_env</span>
<span class="op">}</span>

<span class="fu">to_math</span><span class="op">(</span><span class="va">pi</span><span class="op">)</span>
<span class="co">#&gt; &lt;LATEX&gt; \pi</span>
<span class="fu">to_math</span><span class="op">(</span><span class="va">beta</span><span class="op">)</span>
<span class="co">#&gt; &lt;LATEX&gt; \beta</span></code></pre></div>
<p>Looks good so far!</p>
</div>
<div id="unknown-symbols" class="section level3" number="21.3.5">
<h3>
<span class="header-section-number">21.3.5</span> Unknown symbols<a class="anchor" aria-label="anchor" href="#unknown-symbols"><i class="fas fa-link"></i></a>
</h3>
<p>If a symbol isn’t Greek, we want to leave it as is. This is tricky because we don’t know in advance what symbols will be used, and we can’t possibly generate them all. Instead, we’ll use the approach described in Section <a href="expressions.html#ast-funs">18.5</a>: walking the AST to find all symbols. This gives us <code>all_names_rec()</code> and helper <code>all_names()</code>:</p>
<!-- GVW: on first reading I wondered why you bothered to define `switch_expr`, since it only appears to be used once.  Then I saw that there's a second call much further down. Highlight this somehow? -->
<div class="sourceCode" id="cb946"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_names_rec</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">switch_expr</span><span class="op">(</span><span class="va">x</span>,
    constant <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,
    symbol <span class="op">=</span>   <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,
    call <span class="op">=</span>     <span class="fu">flat_map_chr</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="va">all_names</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="va">all_names</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu">all_names_rec</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">all_names</span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span><span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">y</span> <span class="op">+</span> <span class="fu">f</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "x" "y" "a" "b" "c"</span></code></pre></div>
<p>We now want to take that list of symbols and convert it to an environment so that each symbol is mapped to its corresponding string representation (e.g., so <code>eval(quote(x), env)</code> yields <code>"x"</code>). We again use the pattern of converting a named character vector to a list, then converting the list to an environment.</p>
<div class="sourceCode" id="cb947"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">latex_env</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">names</span> <span class="op">&lt;-</span> <span class="fu">all_names</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span>
  <span class="va">symbol_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_environment.html">as_environment</a></span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="va">names</span><span class="op">)</span><span class="op">)</span>

  <span class="va">symbol_env</span>
<span class="op">}</span>

<span class="fu">to_math</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="co">#&gt; &lt;LATEX&gt; x</span>
<span class="fu">to_math</span><span class="op">(</span><span class="va">longvariablename</span><span class="op">)</span>
<span class="co">#&gt; &lt;LATEX&gt; longvariablename</span>
<span class="fu">to_math</span><span class="op">(</span><span class="va">pi</span><span class="op">)</span>
<span class="co">#&gt; &lt;LATEX&gt; pi</span></code></pre></div>
<p>This works, but we need to combine it with the Greek symbols environment. Since we want to give preference to Greek over defaults (e.g., <code>to_math(pi)</code> should give <code>"\\pi"</code>, not <code>"pi"</code>), <code>symbol_env</code> needs to be the parent of <code>greek_env</code>. To do that, we need to make a copy of <code>greek_env</code> with a new parent. This gives us a function that can convert both known (Greek) and unknown symbols.</p>
<div class="sourceCode" id="cb948"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">latex_env</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Unknown symbols</span>
  <span class="va">names</span> <span class="op">&lt;-</span> <span class="fu">all_names</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span>
  <span class="va">symbol_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_environment.html">as_environment</a></span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="va">names</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># Known symbols</span>
  <span class="fu"><a href="https://rlang.r-lib.org/reference/env_clone.html">env_clone</a></span><span class="op">(</span><span class="va">greek_env</span>, parent <span class="op">=</span> <span class="va">symbol_env</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">to_math</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="co">#&gt; &lt;LATEX&gt; x</span>
<span class="fu">to_math</span><span class="op">(</span><span class="va">longvariablename</span><span class="op">)</span>
<span class="co">#&gt; &lt;LATEX&gt; longvariablename</span>
<span class="fu">to_math</span><span class="op">(</span><span class="va">pi</span><span class="op">)</span>
<span class="co">#&gt; &lt;LATEX&gt; \pi</span></code></pre></div>
</div>
<div id="known-functions" class="section level3" number="21.3.6">
<h3>
<span class="header-section-number">21.3.6</span> Known functions<a class="anchor" aria-label="anchor" href="#known-functions"><i class="fas fa-link"></i></a>
</h3>
<p>Next we’ll add functions to our DSL. We’ll start with a couple of helpers that make it easy to add new unary and binary operators. These functions are very simple: they only assemble strings.</p>
<div class="sourceCode" id="cb949"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">unary_op</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">left</span>, <span class="va">right</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rlang.r-lib.org/reference/new_function.html">new_function</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">exprs</a></span><span class="op">(</span>e1 <span class="op">=</span> <span class="op">)</span>,
    <span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">left</span>, <span class="va">e1</span>, <span class="op">!</span><span class="op">!</span><span class="va">right</span><span class="op">)</span>
    <span class="op">)</span>,
    <span class="fu"><a href="https://rlang.r-lib.org/reference/caller_env.html">caller_env</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="va">binary_op</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sep</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rlang.r-lib.org/reference/new_function.html">new_function</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">exprs</a></span><span class="op">(</span>e1 <span class="op">=</span> , e2 <span class="op">=</span> <span class="op">)</span>,
    <span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">e1</span>, <span class="op">!</span><span class="op">!</span><span class="va">sep</span>, <span class="va">e2</span><span class="op">)</span>
    <span class="op">)</span>,
    <span class="fu"><a href="https://rlang.r-lib.org/reference/caller_env.html">caller_env</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="fu">unary_op</span><span class="op">(</span><span class="st">"\\sqrt{"</span>, <span class="st">"}"</span><span class="op">)</span>
<span class="co">#&gt; function (e1) </span>
<span class="co">#&gt; paste0("\\sqrt{", e1, "}")</span>
<span class="fu">binary_op</span><span class="op">(</span><span class="st">"+"</span><span class="op">)</span>
<span class="co">#&gt; function (e1, e2) </span>
<span class="co">#&gt; paste0(e1, "+", e2)</span></code></pre></div>
<p>Using these helpers, we can map a few illustrative examples of converting R to LaTeX. Note that with R’s lexical scoping rules helping us, we can easily provide new meanings for standard functions like <code>+</code>, <code>-</code>, and <code>*</code>, and even <code>(</code> and <code>{</code>.</p>
<div class="sourceCode" id="cb950"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Binary operators</span>
<span class="va">f_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/env.html">child_env</a></span><span class="op">(</span>
  .parent <span class="op">=</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/empty_env.html">empty_env</a></span><span class="op">(</span><span class="op">)</span>,
  `+` <span class="op">=</span> <span class="fu">binary_op</span><span class="op">(</span><span class="st">" + "</span><span class="op">)</span>,
  `-` <span class="op">=</span> <span class="fu">binary_op</span><span class="op">(</span><span class="st">" - "</span><span class="op">)</span>,
  `*` <span class="op">=</span> <span class="fu">binary_op</span><span class="op">(</span><span class="st">" * "</span><span class="op">)</span>,
  `/` <span class="op">=</span> <span class="fu">binary_op</span><span class="op">(</span><span class="st">" / "</span><span class="op">)</span>,
  `^` <span class="op">=</span> <span class="fu">binary_op</span><span class="op">(</span><span class="st">"^"</span><span class="op">)</span>,
  `[` <span class="op">=</span> <span class="fu">binary_op</span><span class="op">(</span><span class="st">"_"</span><span class="op">)</span>,

  <span class="co"># Grouping</span>
  `{` <span class="op">=</span> <span class="fu">unary_op</span><span class="op">(</span><span class="st">"\\left{ "</span>, <span class="st">" \\right}"</span><span class="op">)</span>,
  `(` <span class="op">=</span> <span class="fu">unary_op</span><span class="op">(</span><span class="st">"\\left( "</span>, <span class="st">" \\right)"</span><span class="op">)</span>,
  paste <span class="op">=</span> <span class="va">paste</span>,

  <span class="co"># Other math functions</span>
  sqrt <span class="op">=</span> <span class="fu">unary_op</span><span class="op">(</span><span class="st">"\\sqrt{"</span>, <span class="st">"}"</span><span class="op">)</span>,
  sin <span class="op">=</span>  <span class="fu">unary_op</span><span class="op">(</span><span class="st">"\\sin("</span>, <span class="st">")"</span><span class="op">)</span>,
  log <span class="op">=</span>  <span class="fu">unary_op</span><span class="op">(</span><span class="st">"\\log("</span>, <span class="st">")"</span><span class="op">)</span>,
  abs <span class="op">=</span>  <span class="fu">unary_op</span><span class="op">(</span><span class="st">"\\left| "</span>, <span class="st">"\\right| "</span><span class="op">)</span>,
  frac <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"\\frac{"</span>, <span class="va">a</span>, <span class="st">"}{"</span>, <span class="va">b</span>, <span class="st">"}"</span><span class="op">)</span>
  <span class="op">}</span>,

  <span class="co"># Labelling</span>
  hat <span class="op">=</span>   <span class="fu">unary_op</span><span class="op">(</span><span class="st">"\\hat{"</span>, <span class="st">"}"</span><span class="op">)</span>,
  tilde <span class="op">=</span> <span class="fu">unary_op</span><span class="op">(</span><span class="st">"\\tilde{"</span>, <span class="st">"}"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>We again modify <code>latex_env()</code> to include this environment. It should be the last environment R looks for names in so that expressions like <code>sin(sin)</code> will work.</p>
<div class="sourceCode" id="cb951"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">latex_env</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Known functions</span>
  <span class="va">f_env</span>

  <span class="co"># Default symbols</span>
  <span class="va">names</span> <span class="op">&lt;-</span> <span class="fu">all_names</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span>
  <span class="va">symbol_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_environment.html">as_environment</a></span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="va">names</span><span class="op">)</span>, parent <span class="op">=</span> <span class="va">f_env</span><span class="op">)</span>

  <span class="co"># Known symbols</span>
  <span class="va">greek_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/env_clone.html">env_clone</a></span><span class="op">(</span><span class="va">greek_env</span>, parent <span class="op">=</span> <span class="va">symbol_env</span><span class="op">)</span>

  <span class="va">greek_env</span>
<span class="op">}</span>

<span class="fu">to_math</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">pi</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;LATEX&gt; \sin(x + \pi)</span>
<span class="fu">to_math</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;LATEX&gt; \log(x_i^2)</span>
<span class="fu">to_math</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">sin</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;LATEX&gt; \sin(sin)</span></code></pre></div>
</div>
<div id="unknown-functions" class="section level3" number="21.3.7">
<h3>
<span class="header-section-number">21.3.7</span> Unknown functions<a class="anchor" aria-label="anchor" href="#unknown-functions"><i class="fas fa-link"></i></a>
</h3>
<p>Finally, we’ll add a default for functions that we don’t yet know about. We can’t know in advance what the unknown funtions will be so we again walk the AST to find them:</p>
<div class="sourceCode" id="cb952"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_calls_rec</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">switch_expr</span><span class="op">(</span><span class="va">x</span>,
    constant <span class="op">=</span> ,
    symbol <span class="op">=</span>   <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,
    call <span class="op">=</span> <span class="op">{</span>
      <span class="va">fname</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
      <span class="va">children</span> <span class="op">&lt;-</span> <span class="fu">flat_map_chr</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="va">all_calls</span><span class="op">)</span>
      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">fname</span>, <span class="va">children</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>
<span class="op">}</span>
<span class="va">all_calls</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu">all_calls_rec</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">all_calls</span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">g</span> <span class="op">+</span> <span class="va">b</span>, <span class="va">c</span>, <span class="fu">d</span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "f" "+" "d"</span></code></pre></div>
<p>We need a closure that will generate the functions for each unknown call:</p>
<div class="sourceCode" id="cb953"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">unknown_op</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rlang.r-lib.org/reference/new_function.html">new_function</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">exprs</a></span><span class="op">(</span>... <span class="op">=</span> <span class="op">)</span>,
    <span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span><span class="op">(</span><span class="op">{</span>
      <span class="va">contents</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">...</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"\\mathrm{"</span>, <span class="va">op</span>, <span class="st">"}("</span><span class="op">)</span>, <span class="va">contents</span>, <span class="st">")"</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>
<span class="fu">unknown_op</span><span class="op">(</span><span class="st">"foo"</span><span class="op">)</span>
<span class="co">#&gt; function (...) </span>
<span class="co">#&gt; {</span>
<span class="co">#&gt;     contents &lt;- paste(..., collapse = ", ")</span>
<span class="co">#&gt;     paste0("\\mathrm{foo}(", contents, ")")</span>
<span class="co">#&gt; }</span>
<span class="co">#&gt; &lt;environment: 0x0000000022ec6738&gt;</span></code></pre></div>
<p>And again we update <code>latex_env()</code>:</p>
<div class="sourceCode" id="cb954"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">latex_env</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">calls</span> <span class="op">&lt;-</span> <span class="fu">all_calls</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span>
  <span class="va">call_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="va">calls</span><span class="op">)</span>, <span class="va">unknown_op</span><span class="op">)</span>
  <span class="va">call_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_environment.html">as_environment</a></span><span class="op">(</span><span class="va">call_list</span><span class="op">)</span>

  <span class="co"># Known functions</span>
  <span class="va">f_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/env_clone.html">env_clone</a></span><span class="op">(</span><span class="va">f_env</span>, <span class="va">call_env</span><span class="op">)</span>

  <span class="co"># Default symbols</span>
  <span class="va">names</span> <span class="op">&lt;-</span> <span class="fu">all_names</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span>
  <span class="va">symbol_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/as_environment.html">as_environment</a></span><span class="op">(</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="va">names</span><span class="op">)</span>, parent <span class="op">=</span> <span class="va">f_env</span><span class="op">)</span>

  <span class="co"># Known symbols</span>
  <span class="va">greek_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/env_clone.html">env_clone</a></span><span class="op">(</span><span class="va">greek_env</span>, parent <span class="op">=</span> <span class="va">symbol_env</span><span class="op">)</span>
  <span class="va">greek_env</span>
<span class="op">}</span></code></pre></div>
<p>This completes our original requirements:</p>
<div class="sourceCode" id="cb955"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">to_math</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">pi</span><span class="op">)</span> <span class="op">+</span> <span class="fu">f</span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;LATEX&gt; \sin(\pi) + \mathrm{f}(a)</span></code></pre></div>
<p>You could certainly take this idea further and translate types of mathematical expression, but you should not need any additional metaprogramming tools.</p>
</div>
<div id="exercises-67" class="section level3" number="21.3.8">
<h3>
<span class="header-section-number">21.3.8</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-67"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Add escaping. The special symbols that should be escaped by adding a backslash
in front of them are <code>\</code>, <code>$</code>, and <code>%</code>. Just as with HTML, you’ll need to
make sure you don’t end up double-escaping. So you’ll need to create a small
S3 class and then use that in function operators. That will also allow you
to embed arbitrary LaTeX if needed.</p></li>
<li><p>Complete the DSL to support all the functions that <code>plotmath</code> supports.</p></li>
</ol>
</div>
</div>
</div>




  <div class="chapter-nav">
<div class="prev"><a href="evaluation.html"><span class="header-section-number">20</span> Evaluation</a></div>
<div class="next"><a href="techniques.html">Introduction</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#translation"><span class="header-section-number">21</span> Translating R code</a></li>
<li>
<a class="nav-link" href="#introduction-20"><span class="header-section-number">21.1</span> Introduction</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#outline-19">Outline</a></li>
<li><a class="nav-link" href="#prerequisites-14">Prerequisites</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#html"><span class="header-section-number">21.2</span> HTML</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#goal"><span class="header-section-number">21.2.1</span> Goal</a></li>
<li><a class="nav-link" href="#escaping"><span class="header-section-number">21.2.2</span> Escaping</a></li>
<li><a class="nav-link" href="#basic-tag-functions"><span class="header-section-number">21.2.3</span> Basic tag functions</a></li>
<li><a class="nav-link" href="#tag-functions"><span class="header-section-number">21.2.4</span> Tag functions</a></li>
<li><a class="nav-link" href="#html-env"><span class="header-section-number">21.2.5</span> Processing all tags</a></li>
<li><a class="nav-link" href="#exercises-66"><span class="header-section-number">21.2.6</span> Exercises</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#latex"><span class="header-section-number">21.3</span> LaTeX</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#latex-mathematics"><span class="header-section-number">21.3.1</span> LaTeX mathematics</a></li>
<li><a class="nav-link" href="#goal-1"><span class="header-section-number">21.3.2</span> Goal</a></li>
<li><a class="nav-link" href="#to_math"><span class="header-section-number">21.3.3</span> to_math()</a></li>
<li><a class="nav-link" href="#known-symbols"><span class="header-section-number">21.3.4</span> Known symbols</a></li>
<li><a class="nav-link" href="#unknown-symbols"><span class="header-section-number">21.3.5</span> Unknown symbols</a></li>
<li><a class="nav-link" href="#known-functions"><span class="header-section-number">21.3.6</span> Known functions</a></li>
<li><a class="nav-link" href="#unknown-functions"><span class="header-section-number">21.3.7</span> Unknown functions</a></li>
<li><a class="nav-link" href="#exercises-67"><span class="header-section-number">21.3.8</span> Exercises</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/hadley/adv-r/blob/master/Translation.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/hadley/adv-r/edit/master/Translation.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R avanzado</strong>" was written by Jeshua Romero Guadarrama. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
